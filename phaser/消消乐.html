<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>消消乐 | smallzip‘s Blog</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="smallzip 个人博客">
    <link rel="preload" href="/assets/css/0.styles.2fc78481.css" as="style"><link rel="preload" href="/assets/js/app.7d4f3de2.js" as="script"><link rel="preload" href="/assets/js/2.26b4ca92.js" as="script"><link rel="preload" href="/assets/js/43.3f9d03e3.js" as="script"><link rel="prefetch" href="/assets/js/10.b317bce3.js"><link rel="prefetch" href="/assets/js/11.8ee6c761.js"><link rel="prefetch" href="/assets/js/12.53e9bc3d.js"><link rel="prefetch" href="/assets/js/13.d11e5bb2.js"><link rel="prefetch" href="/assets/js/14.1a7ac3aa.js"><link rel="prefetch" href="/assets/js/15.95ba698e.js"><link rel="prefetch" href="/assets/js/16.12cc2725.js"><link rel="prefetch" href="/assets/js/17.0c5dc206.js"><link rel="prefetch" href="/assets/js/18.a740cbf4.js"><link rel="prefetch" href="/assets/js/19.f3a4b9e9.js"><link rel="prefetch" href="/assets/js/20.cb81e1bb.js"><link rel="prefetch" href="/assets/js/21.30ba2eb0.js"><link rel="prefetch" href="/assets/js/22.9a57d305.js"><link rel="prefetch" href="/assets/js/23.f184478a.js"><link rel="prefetch" href="/assets/js/24.1a9da5cc.js"><link rel="prefetch" href="/assets/js/25.9c5fc5df.js"><link rel="prefetch" href="/assets/js/26.a05f5cb7.js"><link rel="prefetch" href="/assets/js/27.824f59c5.js"><link rel="prefetch" href="/assets/js/28.ddbde7dc.js"><link rel="prefetch" href="/assets/js/29.d5273140.js"><link rel="prefetch" href="/assets/js/3.b4eb5e10.js"><link rel="prefetch" href="/assets/js/30.6450fecd.js"><link rel="prefetch" href="/assets/js/31.aac633e0.js"><link rel="prefetch" href="/assets/js/32.0eee40b0.js"><link rel="prefetch" href="/assets/js/33.c0127169.js"><link rel="prefetch" href="/assets/js/34.403722d8.js"><link rel="prefetch" href="/assets/js/35.aa5041e5.js"><link rel="prefetch" href="/assets/js/36.985b8158.js"><link rel="prefetch" href="/assets/js/37.08e49cde.js"><link rel="prefetch" href="/assets/js/38.21290fcb.js"><link rel="prefetch" href="/assets/js/39.69a5f5a9.js"><link rel="prefetch" href="/assets/js/4.53121559.js"><link rel="prefetch" href="/assets/js/40.d8288902.js"><link rel="prefetch" href="/assets/js/41.23fba485.js"><link rel="prefetch" href="/assets/js/42.c64155f7.js"><link rel="prefetch" href="/assets/js/44.d04f9b22.js"><link rel="prefetch" href="/assets/js/45.1791fee7.js"><link rel="prefetch" href="/assets/js/46.aa8ff59b.js"><link rel="prefetch" href="/assets/js/47.db1c8f44.js"><link rel="prefetch" href="/assets/js/48.c2e263aa.js"><link rel="prefetch" href="/assets/js/49.e6cb0744.js"><link rel="prefetch" href="/assets/js/5.f9da8c69.js"><link rel="prefetch" href="/assets/js/50.89c360b1.js"><link rel="prefetch" href="/assets/js/51.3aa0cc1e.js"><link rel="prefetch" href="/assets/js/52.4cb1b1f8.js"><link rel="prefetch" href="/assets/js/53.f5ce2d95.js"><link rel="prefetch" href="/assets/js/54.d31076f1.js"><link rel="prefetch" href="/assets/js/55.cdaa4e53.js"><link rel="prefetch" href="/assets/js/56.4cb18d0b.js"><link rel="prefetch" href="/assets/js/57.41f6c005.js"><link rel="prefetch" href="/assets/js/58.40a34bf6.js"><link rel="prefetch" href="/assets/js/59.58bc3b05.js"><link rel="prefetch" href="/assets/js/6.1a146ec0.js"><link rel="prefetch" href="/assets/js/60.93d31dd5.js"><link rel="prefetch" href="/assets/js/61.ddb5fc0c.js"><link rel="prefetch" href="/assets/js/62.d4f15634.js"><link rel="prefetch" href="/assets/js/63.f9284901.js"><link rel="prefetch" href="/assets/js/64.ceaab1d0.js"><link rel="prefetch" href="/assets/js/65.443d5ce9.js"><link rel="prefetch" href="/assets/js/66.11b7fa9d.js"><link rel="prefetch" href="/assets/js/67.d4b48018.js"><link rel="prefetch" href="/assets/js/7.920bce8f.js"><link rel="prefetch" href="/assets/js/8.3fcb3827.js"><link rel="prefetch" href="/assets/js/9.2da28544.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2fc78481.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">smallzip‘s Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/e0d0e6cb34d2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://juejin.im/user/5a68b1945188256922633d02" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/jianpiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/e0d0e6cb34d2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://juejin.im/user/5a68b1945188256922633d02" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/jianpiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/《javascript高级程序设计》笔记.html" class="sidebar-link">《javascript高级程序设计》笔记</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>javascript技术积累</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/linux笔记.html" class="sidebar-link">linux笔记</a></li><li><a href="/linux课堂代码案例.html" class="sidebar-link">linux课堂代码案例</a></li><li><a href="/算法学习笔记.html" class="sidebar-link">算法学习笔记</a></li><li><a href="/js数据结构与算法.html" class="sidebar-link">js数据结构与算法</a></li><li><a href="/javascript设计模式.html" class="sidebar-link">javascript设计模式</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>phaser游戏引擎</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/phaser/红包雨.html" class="sidebar-link">红包雨</a></li><li><a href="/phaser/消消乐.html" class="active sidebar-link">消消乐</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/phaser/消消乐.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/phaser/消消乐.html#目标" class="sidebar-link">目标</a></li><li class="sidebar-sub-header"><a href="/phaser/消消乐.html#消消乐游戏" class="sidebar-link">消消乐游戏</a></li><li class="sidebar-sub-header"><a href="/phaser/消消乐.html#游戏核心概括" class="sidebar-link">游戏核心概括</a></li><li class="sidebar-sub-header"><a href="/phaser/消消乐.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/phaser/消消乐.html#参考文献" class="sidebar-link">参考文献</a></li></ul></li><li><a href="/phaser/摘星星.html" class="sidebar-link">Phaser游戏引擎初体验</a></li><li><a href="/phaser/实践与总结.html" class="sidebar-link">实践的思考与总结</a></li></ul></section></li><li><a href="/了解HTTP.html" class="sidebar-link">了解HTTP</a></li><li><a href="/Flutter学习笔记.html" class="sidebar-link">Flutter学习笔记</a></li><li><a href="/css学习笔记.html" class="sidebar-link">css学习笔记</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React记录</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/React-Native.html" class="sidebar-link">React-Native记录</a></li><li><a href="/小程序记录.html" class="sidebar-link">小程序笔记</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/webpack.html" class="sidebar-link">Webpack</a></li><li><a href="/js正则积累.html" class="sidebar-link">js正则积累</a></li><li><a href="/前端题目练习.html" class="sidebar-link">前端题目练习</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务器端积累</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/计算机基础.html" class="sidebar-link">计算机基础</a></li><li><a href="/网络基础知识.html" class="sidebar-link">网络基础</a></li><li><a href="/基础面试要点知识.html" class="sidebar-link">基础面试知识积累</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="消消乐"><a href="#消消乐" class="header-anchor">#</a> 消消乐</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>上次学习了phaser的基本使用，并且写了一个摘星星的游戏，颇为有趣。对phaser的场景、画布、精灵、物理引擎有了深入的认识。</p> <p>想起在深圳实习的时候，挤地铁上下班期间经常看到有人在玩消消乐游戏，那咱们也来实现一个消消乐游戏。</p> <h2 id="目标"><a href="#目标" class="header-anchor">#</a> 目标</h2> <p>消消乐支持PC端玩耍，也支持手机端玩耍，游戏尺寸能够适配各种移动设备。</p> <p><strong>游戏规则</strong></p> <ul><li>x轴或者y轴连续3个格子相同即可被消除</li> <li>消除之后随机补充格子</li> <li>游戏有关卡机制，每关游戏时长为10秒钟</li> <li>从第二关开始，每过一关新增两个障碍物</li></ul> <h2 id="消消乐游戏"><a href="#消消乐游戏" class="header-anchor">#</a> 消消乐游戏</h2> <p>这里以phaser2版本作为游戏开发基础。</p> <h2 id="游戏核心概括"><a href="#游戏核心概括" class="header-anchor">#</a> 游戏核心概括</h2> <p><img src="https://pic2.zhimg.com/80/v2-25f99bcb0c93f859896ab7329a7f9dbd_720w.png" alt="游戏核心概括图"></p> <h3 id="游戏环境搭建"><a href="#游戏环境搭建" class="header-anchor">#</a> 游戏环境搭建</h3> <p>消消乐游戏相比于摘星星来说复杂很多，这里将html和js分离，有利于更好的开发和维护。</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype">&lt;!DOCTYPE html&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text/css<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
    <span class="token selector">body</span> <span class="token punctuation">{</span>
      <span class="token property">background</span><span class="token punctuation">:</span> #000000<span class="token punctuation">;</span>
      <span class="token property">padding</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
      <span class="token property">margin</span><span class="token punctuation">:</span> 0px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>phaser.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>game.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>总共有两个JavaScript文件，一个的<code>phaser.js</code>引擎文件，需要放在上面，下面的<code>game.js</code>是游戏开发文件。</p> <p>页面加载完毕后开始创建并执行游戏。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> game<span class="token punctuation">;</span>

<span class="token comment">// 游戏的基本配置信息，用于创建游戏画布</span>
<span class="token keyword">const</span> gameOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  gameWidth<span class="token operator">:</span> <span class="token number">800</span><span class="token punctuation">,</span>    <span class="token comment">// 游戏宽度，以像素为单位</span>
  gameHeight<span class="token operator">:</span> <span class="token number">1300</span><span class="token punctuation">,</span>   <span class="token comment">// 游戏高低，以像素为单位</span>
  tileSize<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>     <span class="token comment">// 瓦片（一个格子）的尺寸，以像素为单位</span>
  fieldSize<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// 场地大小，场地应该是正方形的，这样才能流畅地进行游戏，这里设置为 8 X 8 的矩阵</span>
  colors<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0xff0000</span><span class="token punctuation">,</span> <span class="token number">0x00ff00</span><span class="token punctuation">,</span> <span class="token number">0x0000ff</span><span class="token punctuation">,</span> <span class="token number">0xffff00</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 瓦片（格子）的颜色</span>
  tiles<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'dog'</span><span class="token punctuation">,</span> <span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token string">'gh'</span><span class="token punctuation">,</span> <span class="token string">'tu'</span><span class="token punctuation">]</span> <span class="token comment">// 四种格子元素</span>
<span class="token punctuation">}</span>
  
<span class="token comment">// 让它在页面加载后执行</span>
window<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 使用Phaser引擎创建一个游戏</span>
  game <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phaser<span class="token punctuation">.</span>Game</span><span class="token punctuation">(</span>gameOptions<span class="token punctuation">.</span>gameWidth<span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>gameHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 添加游戏</span>
  game<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;TheGame&quot;</span><span class="token punctuation">,</span> TheGame<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 启动游戏</span>
  game<span class="token punctuation">.</span>state<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">&quot;TheGame&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>把游戏添加到<code>state</code>场景中，然后将场景中的游戏启动。</p> <blockquote><p><code>phaser2</code>的场景函数是<code>state</code>，<code>phaser3</code>的场景函数为<code>scene</code>，这里有一点点区别。</p></blockquote> <h3 id="预加载资源"><a href="#预加载资源" class="header-anchor">#</a> 预加载资源</h3> <p><code>Phaser</code>提供了资源加载的监听函数<code>this.load.on</code>, 有两个参数，第一个参数是监听的函数名称，第二个参数是回调函数，回调函数携带一个进度参数，值为0到1，一般我们会使用百分比的形式展示进度情况。</p> <p>监听加载进度的代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">this</span><span class="token punctuation">.</span>load<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'progress'</span><span class="token punctuation">,</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//value 是个0-1的浮点数</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>搭建舞台场景，设置舞台的背景色（后面添加背景图会覆盖掉）。</p> <p>加载瓦片的资源，游戏中用到所有资源在此逐一加载。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 资源预加载，会在phaser预加载期间执行，可以实时监控资源加载的进度</span>
<span class="token function">preload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// 设置舞台背景色</span>
  game<span class="token punctuation">.</span>stage<span class="token punctuation">.</span>backgroundColor <span class="token operator">=</span> <span class="token number">0x222222</span><span class="token punctuation">;</span>

  <span class="token comment">// 加载瓦片资源</span>
  game<span class="token punctuation">.</span>load<span class="token punctuation">.</span><span class="token function">spritesheet</span><span class="token punctuation">(</span><span class="token string">&quot;tiles&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./assets/tiles.png&quot;</span><span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  game<span class="token punctuation">.</span>load<span class="token punctuation">.</span><span class="token function">spritesheet</span><span class="token punctuation">(</span><span class="token string">&quot;cat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./assets/mao.png&quot;</span><span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  game<span class="token punctuation">.</span>load<span class="token punctuation">.</span><span class="token function">spritesheet</span><span class="token punctuation">(</span><span class="token string">&quot;dog&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./assets/gou.png&quot;</span><span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  game<span class="token punctuation">.</span>load<span class="token punctuation">.</span><span class="token function">spritesheet</span><span class="token punctuation">(</span><span class="token string">&quot;chicken&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./assets/ji.png&quot;</span><span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  game<span class="token punctuation">.</span>load<span class="token punctuation">.</span><span class="token function">spritesheet</span><span class="token punctuation">(</span><span class="token string">&quot;tu&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./assets/tu.png&quot;</span><span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  game<span class="token punctuation">.</span>load<span class="token punctuation">.</span><span class="token function">spritesheet</span><span class="token punctuation">(</span><span class="token string">&quot;gh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./assets/gh.png&quot;</span><span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 加载按钮资源</span>
  game<span class="token punctuation">.</span>load<span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">,</span> <span class="token string">&quot;./assets/anniu.png&quot;</span><span class="token punctuation">)</span>

  <span class="token comment">// 加载背景资源</span>
  game<span class="token punctuation">.</span>load<span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string">'bg'</span><span class="token punctuation">,</span> <span class="token string">&quot;./assets/bg.png&quot;</span><span class="token punctuation">)</span>
  game<span class="token punctuation">.</span>load<span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string">'bg1'</span><span class="token punctuation">,</span> <span class="token string">&quot;./assets/bg1.png&quot;</span><span class="token punctuation">)</span>
  game<span class="token punctuation">.</span>load<span class="token punctuation">.</span><span class="token function">image</span><span class="token punctuation">(</span><span class="token string">'bg2'</span><span class="token punctuation">,</span> <span class="token string">&quot;./assets/bg2.png&quot;</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="创建游戏画布"><a href="#创建游戏画布" class="header-anchor">#</a> 创建游戏画布</h3> <p>创建游戏画布，在游戏完全加载后立即执行。</p> <p>这里可以设置画布的比例，以及适配方案，官网提供了五种画布适配的方案</p> <ul><li><a href="https://phaser.io/docs/2.4.4/Phaser.ScaleManager.html#.EXACT_FIT" target="_blank" rel="noopener noreferrer">.EXACT_FIT<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ：扩展内容以填充所有可用空间的比例模式</li> <li><a href="https://phaser.io/docs/2.4.4/Phaser.ScaleManager.html#.NO_SCALE" target="_blank" rel="noopener noreferrer">.NO_SCALE<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：一种防止任何缩放的缩放模式</li> <li><a href="https://phaser.io/docs/2.4.4/Phaser.ScaleManager.html#.RESIZE" target="_blank" rel="noopener noreferrer">.RESIZE<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：导致游戏大小改变的缩放模式</li> <li><a href="https://phaser.io/docs/2.4.4/Phaser.ScaleManager.html#.SHOW_ALL" target="_blank" rel="noopener noreferrer">.SHOW_ALL<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：缩放模式，在保持比例的同时显示整个游戏</li> <li><a href="https://phaser.io/docs/2.4.4/Phaser.ScaleManager.html#.USER_SCALE" target="_blank" rel="noopener noreferrer">.USER_SCALE<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：一种允许自定义比例设置的自定义模式</li></ul> <p>这里，我选择了全尺寸适配方案（SHOW_ALL），直接铺满整个游戏，同时让游戏水平居中。</p> <p>舞台布置完毕，去创建游戏元素，和游戏关卡。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 创建游戏画布，在游戏完全加载后立即执行</span>
  <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 将游戏覆盖整个屏幕，同时保持其比例</span>
    game<span class="token punctuation">.</span>scale<span class="token punctuation">.</span>scaleMode <span class="token operator">=</span> Phaser<span class="token punctuation">.</span>ScaleManager<span class="token punctuation">.</span><span class="token constant">SHOW_ALL</span><span class="token punctuation">;</span>

    <span class="token comment">// 游戏水平居中</span>
    game<span class="token punctuation">.</span>scale<span class="token punctuation">.</span>pageAlignHorizontally <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// 游戏垂直居中</span>
    game<span class="token punctuation">.</span>scale<span class="token punctuation">.</span>pageAlignVertically <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建游戏</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>canPick <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>finishAnimation <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token comment">// 创建关卡</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="创建游戏元素"><a href="#创建游戏元素" class="header-anchor">#</a> 创建游戏元素</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 创建游戏元素</span>
  <span class="token function">createMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// canPick告诉我们，如果我们可以选择一个贴图，我们从“true”开始，有一个贴图可以被选择</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>canPick <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// tiles保存在一个名为tilesArray的数组中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> bg <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">tileSprite</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> game<span class="token punctuation">.</span>width<span class="token punctuation">,</span> game<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token string">'bg1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bg<span class="token punctuation">.</span>tint <span class="token operator">=</span> <span class="token number">0xcccccc</span>

    <span class="token comment">// 这个组将包含所有的贴图</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 用来存储存所有瓦片格子的位置</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>specialItemCandidates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 矩阵的网格，由x轴和y轴组成，矩阵的x轴和y轴数量由gameOptions的x和y构成</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> gameOptions<span class="token punctuation">.</span>fieldSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> gameOptions<span class="token punctuation">.</span>fieldSize<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 创建格子元素</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addTile</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将每个坐标添加到数组中</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>specialItemCandidates<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Phaser<span class="token punctuation">.</span>Point</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 随机选择一个位置放置障碍物</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>heroLocation <span class="token operator">=</span> Phaser<span class="token punctuation">.</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">removeRandomItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>specialItemCandidates<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 调整画布</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>heroLocation<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>heroLocation<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>tileSprite<span class="token punctuation">.</span>frame <span class="token operator">=</span> _HERO<span class="token punctuation">;</span>

    <span class="token comment">// 调整格子的值。我们可以通过给帧添加10来定义特殊的贴图值</span>
    <span class="token comment">// this.tilesArray[this.heroLocation.y][this.heroLocation.x].value = 10 + _HERO;</span>

    <span class="token comment">// 我们还必须通过应用白色着色来去除着色</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>heroLocation<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>heroLocation<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>tileSprite<span class="token punctuation">.</span>tint <span class="token operator">=</span> <span class="token number">0xffffff</span><span class="token punctuation">;</span>

    <span class="token comment">// 我们在画布中以水平和垂直方式居中</span>
    <span class="token keyword">const</span> fieldWidth <span class="token operator">=</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">*</span> gameOptions<span class="token punctuation">.</span>fieldSize<span class="token punctuation">;</span>

    <span class="token comment">// 将组放在画布的中间</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token punctuation">(</span>game<span class="token punctuation">.</span>width <span class="token operator">-</span> fieldWidth<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token punctuation">(</span>game<span class="token punctuation">.</span>height <span class="token operator">-</span> fieldWidth<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置组，让它的焦点保持在重点位置</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>pivot<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>fieldWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> fieldWidth <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 调整分组位置，使其保持在之前分配的位置</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>pivot<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>pivot<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 我们将绘制一个蒙版来隐藏从上面落下的方块。蒙版需要有相同的大小和位置的组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileMask <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">graphics</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>pivot<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>pivot<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileMask<span class="token punctuation">.</span><span class="token function">beginFill</span><span class="token punctuation">(</span><span class="token number">0xffffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileMask<span class="token punctuation">.</span><span class="token function">drawRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> fieldWidth<span class="token punctuation">,</span> fieldWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>mask <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileMask<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileMask<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// 它将包含被回收的已移除的格子</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tilePool <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 添加一个分数文案，记录分数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scoreText <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>game<span class="token punctuation">.</span>world<span class="token punctuation">.</span>centerX<span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>score<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">分</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> font<span class="token operator">:</span> <span class="token string">&quot;70px serif&quot;</span><span class="token punctuation">,</span> fill<span class="token operator">:</span> <span class="token string">&quot;#ffffff&quot;</span><span class="token punctuation">,</span> align<span class="token operator">:</span> <span class="token string">&quot;center&quot;</span><span class="token punctuation">,</span> fontWeight<span class="token operator">:</span> <span class="token string">&quot;bold&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 设置锚点居中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>scoreText<span class="token punctuation">.</span>anchor<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>

    <span class="token comment">// 添加一个倒计时</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gameTime <span class="token operator">=</span> _GAMETIME
    <span class="token comment">// 倒计时文案</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gameTimeText <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>game<span class="token punctuation">.</span>world<span class="token punctuation">.</span>centerX<span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">倒计时：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>gameTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> font<span class="token operator">:</span> <span class="token string">&quot;45px serif&quot;</span><span class="token punctuation">,</span> fill<span class="token operator">:</span> <span class="token string">&quot;#ffffff&quot;</span><span class="token punctuation">,</span> align<span class="token operator">:</span> <span class="token string">&quot;center&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 设置锚点居中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gameTimeText<span class="token punctuation">.</span>anchor<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>

    <span class="token comment">// 游戏关卡</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gameLevelText <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>game<span class="token punctuation">.</span>world<span class="token punctuation">.</span>centerX<span class="token punctuation">,</span> <span class="token number">1200</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">第</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>levelCount <span class="token operator">||</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">关</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span> font<span class="token operator">:</span> <span class="token string">&quot;45px serif&quot;</span><span class="token punctuation">,</span> fill<span class="token operator">:</span> <span class="token string">&quot;#ffffff&quot;</span><span class="token punctuation">,</span> align<span class="token operator">:</span> <span class="token string">&quot;center&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 设置锚点居中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gameLevelText<span class="token punctuation">.</span>anchor<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>

    <span class="token comment">// 玩家点击事件</span>
    game<span class="token punctuation">.</span>input<span class="token punctuation">.</span>onDown<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pickTile<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="创建格子元素"><a href="#创建格子元素" class="header-anchor">#</a> 创建格子元素</h3> <p>矩阵中的每个格子由<code>sprite</code>瓦片创建。<code>sprite</code>瓦片创建时第三个参数为字符串<code>key</code>,可以是<code>peload</code>函数中加载的资源所提供的<code>key</code>值，因此我们可以利用随机值，从<code>'dog', 'cat', 'gh', 'tu'</code>中随便挑选一张即可。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 创建消消乐水平和垂直给格子的画布图</span>
  <span class="token function">addTile</span><span class="token punctuation">(</span><span class="token parameter">row<span class="token punctuation">,</span> col</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 根据瓦片大小确定x轴和y轴瓦片位置</span>
    <span class="token keyword">const</span> tileXPos <span class="token operator">=</span> col <span class="token operator">*</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">+</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tileYPos <span class="token operator">=</span> row <span class="token operator">*</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">+</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token comment">// 给格子分配一个随机值，通过这个值来检查是否属于同类</span>
    <span class="token keyword">const</span> tileValue <span class="token operator">=</span> game<span class="token punctuation">.</span>rnd<span class="token punctuation">.</span><span class="token function">integerInRange</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tiles<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建一个由图片制作的瓦片</span>
    <span class="token keyword">const</span> theTile <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">sprite</span><span class="token punctuation">(</span>tileXPos<span class="token punctuation">,</span> tileYPos<span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tiles<span class="token punctuation">[</span>tileValue<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置贴图的注册点到它的中心</span>
    theTile<span class="token punctuation">.</span>anchor<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据瓦片的大小调整瓦片的宽度和高度</span>
    theTile<span class="token punctuation">.</span>width <span class="token operator">=</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">;</span>
    theTile<span class="token punctuation">.</span>height <span class="token operator">=</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">;</span>

    <span class="token comment">// 设置填充色</span>
    <span class="token comment">// theTile.tint = gameOptions.tiles[tileValue];</span>

    <span class="token comment">// 创建一个数组，图像收集到tilesArray数组内</span>
    <span class="token comment">// 最终形成的就是我们看到的整体布局</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>row<span class="token punctuation">]</span><span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      tileSprite<span class="token operator">:</span> theTile<span class="token punctuation">,</span> <span class="token comment">// 画布图像，格子</span>
      isEmpty<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 判断在矩阵的当前位置是否为空（被消掉），为空则创建新的瓦片填充进来</span>
      coordinate<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Phaser<span class="token punctuation">.</span>Point</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> row<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 存储瓦片坐标，在新的瓦片填充期间有用</span>
      value<span class="token operator">:</span> tileValue <span class="token comment">// 瓦片的值</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 并将其添加到格子数组</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>theTile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="创建游戏关卡"><a href="#创建游戏关卡" class="header-anchor">#</a> 创建游戏关卡</h3> <p>游戏关卡展示窗口布满整个屏幕，我选择了一张可爱的图片，直接平铺，在页面中间展示关卡信息。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 创建关卡</span>
  <span class="token function">createLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 关卡元素组合</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelGroup <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">const</span> levelBg <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">tileSprite</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> game<span class="token punctuation">.</span>width<span class="token punctuation">,</span> game<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token string">'bg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    levelBg<span class="token punctuation">.</span>tint <span class="token operator">=</span> <span class="token number">0xe4e4e4</span>
    <span class="token comment">// 关卡等级</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelCount <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token comment">// 关卡显示文案</span>
    <span class="token keyword">const</span> levelTextStyle <span class="token operator">=</span> <span class="token punctuation">{</span> font<span class="token operator">:</span> <span class="token string">&quot;120px serif&quot;</span><span class="token punctuation">,</span> fill<span class="token operator">:</span> <span class="token string">&quot;#ffffff&quot;</span><span class="token punctuation">,</span> align<span class="token operator">:</span> <span class="token string">&quot;center&quot;</span> <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelText <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>game<span class="token punctuation">.</span>world<span class="token punctuation">.</span>centerX<span class="token punctuation">,</span> game<span class="token punctuation">.</span>world<span class="token punctuation">.</span>centerY <span class="token operator">-</span> <span class="token number">140</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">第</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>levelCount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">关</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> levelTextStyle<span class="token punctuation">)</span>
    <span class="token comment">// 设置锚点居中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelText<span class="token punctuation">.</span>anchor<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
    <span class="token comment">// 关卡</span>
    <span class="token keyword">const</span> levelDesStyle <span class="token operator">=</span> <span class="token punctuation">{</span> font<span class="token operator">:</span> <span class="token string">&quot;60px serif&quot;</span><span class="token punctuation">,</span> fill<span class="token operator">:</span> <span class="token string">&quot;#ffffff&quot;</span><span class="token punctuation">,</span> align<span class="token operator">:</span> <span class="token string">&quot;center&quot;</span><span class="token punctuation">,</span> fontWeight<span class="token operator">:</span> <span class="token string">&quot;bold&quot;</span> <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelDes <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>game<span class="token punctuation">.</span>world<span class="token punctuation">.</span>centerX<span class="token punctuation">,</span> game<span class="token punctuation">.</span>world<span class="token punctuation">.</span>centerY<span class="token punctuation">,</span> _LEVEL<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>levelCount<span class="token punctuation">]</span><span class="token punctuation">,</span> levelDesStyle<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelDes<span class="token punctuation">.</span>anchor<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>
    <span class="token comment">// 开始按钮背景</span>
    <span class="token keyword">const</span> button <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">button</span><span class="token punctuation">(</span>game<span class="token punctuation">.</span>world<span class="token punctuation">.</span>centerX<span class="token punctuation">,</span> game<span class="token punctuation">.</span>world<span class="token punctuation">.</span>centerY <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">&quot;button&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 显示游戏矩阵视图</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token comment">// 启动倒计时</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setGameTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 隐藏关卡展示</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>levelGroup<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token comment">// 500毫秒之后才可以点击，防止玩家手速过快，点击确认就立马被触发</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>canPick <span class="token operator">=</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    button<span class="token punctuation">.</span>anchor<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment">// 按钮文字</span>
    <span class="token keyword">const</span> startText <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">text</span><span class="token punctuation">(</span>game<span class="token punctuation">.</span>world<span class="token punctuation">.</span>centerX<span class="token punctuation">,</span> game<span class="token punctuation">.</span>world<span class="token punctuation">.</span>centerY <span class="token operator">+</span> <span class="token number">145</span><span class="token punctuation">,</span> <span class="token string">&quot;开始游戏&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> font<span class="token operator">:</span> <span class="token string">&quot;30px serif&quot;</span><span class="token punctuation">,</span> fill<span class="token operator">:</span> <span class="token string">&quot;#ffffff&quot;</span><span class="token punctuation">,</span> align<span class="token operator">:</span> <span class="token string">&quot;center&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    startText<span class="token punctuation">.</span>anchor<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span>

    <span class="token comment">// 将上面元素都添加都这个组里面，统一管理</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelGroup<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>levelBg<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelGroup<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>levelText<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelGroup<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>levelDes<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelGroup<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>button<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelGroup<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>startText<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="计时器"><a href="#计时器" class="header-anchor">#</a> 计时器</h3> <p>每一个关卡有十秒钟的游戏时长，从10开始逐渐递减。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 计时器，关卡累加器</span>
  <span class="token function">setGameTimer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gameTimer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gameTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gameTime <span class="token operator">-=</span> <span class="token number">1</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>gameTimeText<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">倒计时：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>gameTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 动画未执行完毕，直接退出</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>finishAnimation<span class="token punctuation">)</span> <span class="token keyword">return</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replayGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="下一关，继续游戏"><a href="#下一关，继续游戏" class="header-anchor">#</a> 下一关，继续游戏</h3> <p>当游戏时长为0，则切换到关卡窗口，把游戏矩阵隐藏掉。等待玩家在游戏关卡窗口点击，继续游戏操作。</p> <p>从第二关开始，没关递增两个障碍物，障碍物是不可以点击的。</p> <p>为增加游戏乐趣，每一关给个提示语，总共给十个提示语：</p> <blockquote><p>1: '一马当先',</p> <p>2: '二横开泰',</p> <p>3: '三生有幸',</p> <p>4: '四季如春',</p> <p>5: '五福东海',</p> <p>6: '六六大顺',</p> <p>7: '七嘴八舌',</p> <p>8: '八仙过海',</p> <p>9: '九九归一',</p> <p>10: '十分顺利'</p></blockquote> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 重新开始游戏</span>
  <span class="token function">replayGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>canPick <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelGroup<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelCount <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelText<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">第</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>levelCount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">关</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>levelDes<span class="token punctuation">.</span>text <span class="token operator">=</span> _LEVEL<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>levelCount<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token string">'天下无敌，你最牛逼'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gameLevelText<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">第</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>levelCount<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">关</span><span class="token template-punctuation string">`</span></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gameTimer<span class="token punctuation">)</span>
    <span class="token comment">// 重置倒计时时间</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>gameTime <span class="token operator">=</span> _GAMETIME
    <span class="token keyword">this</span><span class="token punctuation">.</span>gameTimeText<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">倒计时：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>gameTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="障碍物"><a href="#障碍物" class="header-anchor">#</a> 障碍物</h3> <p>设置障碍物不可点击。其次为了让用户知道哪些是障碍物，给它填充成为黑色，直接黑化。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">replayGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">/** 省略 **/</span>
  
  <span class="token comment">// 增加游戏难度，给两个障碍物</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>levelCount <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>levelCount <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 随机选取元素（这其中会包含重复的value）</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> keyLocation <span class="token operator">=</span> Phaser<span class="token punctuation">.</span>ArrayUtils<span class="token punctuation">.</span><span class="token function">removeRandomItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>specialItemCandidates<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isAdjacent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>heroLocation<span class="token punctuation">,</span> keyLocation<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>keyLocation<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>keyLocation<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>tileSprite<span class="token punctuation">.</span>frame <span class="token operator">=</span> _KEY<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>keyLocation<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>keyLocation<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">+</span> _KEY<span class="token punctuation">;</span> <span class="token comment">// 设置为独立的key，让它不被同类型格子元素销毁</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>keyLocation<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>keyLocation<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>tileSprite<span class="token punctuation">.</span>tint <span class="token operator">=</span> <span class="token number">0x000000</span><span class="token punctuation">;</span> <span class="token comment">// 设置背景会黑色（黑化）</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="点击格子"><a href="#点击格子" class="header-anchor">#</a> 点击格子</h3> <p>静态游戏画布搭建完毕，咱们开始玩游戏啦~</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 在玩家点击或触摸时执行</span>
  <span class="token function">pickTile</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 判断是否可以点击，在瓦片还在填充期间是不可以点击的</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>canPick<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// 确定tileGroup内触摸的x和y位置</span>
      <span class="token keyword">const</span> posX <span class="token operator">=</span> e<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>x <span class="token operator">+</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">*</span> gameOptions<span class="token punctuation">.</span>fieldSize <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> posY <span class="token operator">=</span> e<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span>y <span class="token operator">+</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">*</span> gameOptions<span class="token punctuation">.</span>fieldSize <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

      <span class="token comment">// 将坐标转换为实际的行和列</span>
      <span class="token keyword">const</span> pickedRow <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>posY <span class="token operator">/</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> pickedCol <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>posX <span class="token operator">/</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 检查行和列是否在实际的游戏领域内</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>pickedRow <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pickedCol <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pickedRow <span class="token operator">&lt;</span> gameOptions<span class="token punctuation">.</span>fieldSize <span class="token operator">&amp;&amp;</span> pickedCol <span class="token operator">&lt;</span> gameOptions<span class="token punctuation">.</span>fieldSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 选中的格子</span>
        <span class="token keyword">const</span> pickedTile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>pickedRow<span class="token punctuation">]</span><span class="token punctuation">[</span>pickedCol<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>filled <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>filled<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// 在选定的格子上执行填充</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">floodFill</span><span class="token punctuation">(</span>pickedTile<span class="token punctuation">.</span>coordinate<span class="token punctuation">,</span> pickedTile<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// x轴和y轴相关联的数量至少要3个才执行消除操作，这里可以设置</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filled<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

          <span class="token comment">// 玩家将不能点击其他的格子，直到所有的动画播放完毕</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>canPick <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

          <span class="token comment">// 销毁选中的格子以及x轴y轴相关的格子</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroyTiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="递归检查格子四周"><a href="#递归检查格子四周" class="header-anchor">#</a> 递归检查格子四周</h3> <p>递归检查格子上下左右有没有相同值的，有的话就累加到<code>filled</code>数组中，用来计算数量。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 递归遍历查看x轴和y轴是否有相同值的元素</span>
  <span class="token function">floodFill</span><span class="token punctuation">(</span><span class="token parameter">p<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> p<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> p<span class="token punctuation">.</span>x <span class="token operator">&gt;=</span> gameOptions<span class="token punctuation">.</span>fieldSize <span class="token operator">||</span> p<span class="token punctuation">.</span>y <span class="token operator">&gt;=</span> gameOptions<span class="token punctuation">.</span>fieldSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>p<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>p<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>isEmpty <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>p<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>p<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">==</span> n <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pointInArray</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>filled<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">floodFill</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Phaser<span class="token punctuation">.</span>Point</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">floodFill</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Phaser<span class="token punctuation">.</span>Point</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">floodFill</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Phaser<span class="token punctuation">.</span>Point</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">floodFill</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Phaser<span class="token punctuation">.</span>Point</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="超过三个相同格子，执行销毁"><a href="#超过三个相同格子，执行销毁" class="header-anchor">#</a> 超过三个相同格子，执行销毁</h3> <p>递归检查完毕四周，有超过三个以上的格子是相同的，需要将选中的所有格子元素销毁。</p> <p>销毁的过程，给它一点动画效果，从透明度1到0，动画时长0.3秒。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 这个函数将会销毁我们选中的所有格子</span>
  <span class="token function">destroyTiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>finishAnimation <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// 循环遍历数组，逐个删除所有元素</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token comment">// 移除数组的第一个格子元素</span>
      <span class="token keyword">const</span> element <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>filled<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 给格子销毁渐变动画</span>
      <span class="token keyword">const</span> tween <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">tween</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>element<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>element<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>tileSprite<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        alpha<span class="token operator">:</span> <span class="token number">0</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> Phaser<span class="token punctuation">.</span>Easing<span class="token punctuation">.</span>Linear<span class="token punctuation">.</span>None<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// placing the sprite in the array of sprites to be recycled</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tilePool<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>element<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>element<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>tileSprite<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 当补间动画执行完毕</span>
      tween<span class="token punctuation">.</span>onComplete<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 重置补间动画</span>
        e<span class="token punctuation">.</span>frame <span class="token operator">=</span> <span class="token number">0</span>

        <span class="token comment">// 我们不知道我们已经删除了多少个格子，所以计算当前正在使用的补间是一个好方法</span>
        <span class="token comment">// 我们假设，这是最后一个补间 (只有一个补间在运行)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tween<span class="token punctuation">.</span>manager<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

          <span class="token comment">// 执行格子下降动画</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fillVerticalHoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 现在格子是空的</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>element<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">[</span>element<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">.</span>isEmpty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

      <span class="token comment">// 我们将重复这个循环，直到有东西填充进数组</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>filled<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="填充被销毁的格子"><a href="#填充被销毁的格子" class="header-anchor">#</a> 填充被销毁的格子</h3> <p>格子销毁掉，接下来要创建新的格子去填充留空的位置。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 这个函数负责让新的格子落下来</span>
  <span class="token function">fillVerticalHoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 定义个变量，用来告诉我们是否填满了被销毁的格子位置</span>
    <span class="token keyword">var</span> filled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> gameOptions<span class="token punctuation">.</span>fieldSize <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> gameOptions<span class="token punctuation">.</span>fieldSize<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 如果格子不为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>

          <span class="token comment">// 让我们数一下在这块瓷砖下面能找到多少个空的坐标位置</span>
          <span class="token keyword">var</span> holesBelow <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countSpacesBelow</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// 如果留空的位置大于零</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>holesBelow<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// 我们填了一个留空的位置，要处理一下它</span>
            filled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token comment">// 函数将列“j”的平铺从“i”移到“i + holesBelow”行</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">moveDownTile</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> i <span class="token operator">+</span> holesBelow<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果遍历所有的格子，没有完全填充满，则结束执行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>filled<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// 动画执行完毕</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">endMove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 现在是时候重用池中保存的tiles (tilePool数组)了，让我们从遍历每一列开始</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> gameOptions<span class="token punctuation">.</span>fieldSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// 计算每一列有多少空格</span>
      <span class="token keyword">const</span> topHoles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">countSpacesBelow</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 然后遍历每一个空格</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> topHoles <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 设置随机值</span>
        <span class="token keyword">const</span> tileValue <span class="token operator">=</span> game<span class="token punctuation">.</span>rnd<span class="token punctuation">.</span><span class="token function">integerInRange</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tiles<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 让它下落到留空的y轴</span>
        <span class="token keyword">const</span> tileYPos <span class="token operator">=</span> <span class="token punctuation">(</span>j <span class="token operator">-</span> topHoles<span class="token punctuation">)</span> <span class="token operator">*</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">+</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token comment">// x轴</span>
        <span class="token keyword">const</span> tileXPos <span class="token operator">=</span> i <span class="token operator">*</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">+</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>

        <span class="token comment">// 随机创建新的格子元素</span>
        <span class="token keyword">const</span> reusedTile <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">sprite</span><span class="token punctuation">(</span>tileXPos<span class="token punctuation">,</span> tileYPos<span class="token punctuation">,</span> gameOptions<span class="token punctuation">.</span>tiles<span class="token punctuation">[</span>tileValue<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置格子的注册点到它的中心</span>
        reusedTile<span class="token punctuation">.</span>anchor<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 根据瓦片的大小调整瓦片的宽度和高度</span>
        reusedTile<span class="token punctuation">.</span>width <span class="token operator">=</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">;</span>
        reusedTile<span class="token punctuation">.</span>height <span class="token operator">=</span> gameOptions<span class="token punctuation">.</span>tileSize<span class="token punctuation">;</span>

        <span class="token comment">// 填充背景色</span>
        <span class="token comment">// reusedTile.tint = gameOptions.tiles[tileValue];</span>

        <span class="token comment">// 设置新的格子元素</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
          tileSprite<span class="token operator">:</span> reusedTile<span class="token punctuation">,</span>
          isEmpty<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
          coordinate<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Phaser<span class="token punctuation">.</span>Point</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> j<span class="token punctuation">)</span><span class="token punctuation">,</span>
          value<span class="token operator">:</span> tileValue
        <span class="token punctuation">}</span>

        <span class="token comment">// 添加到格子数组中，目的是为了让格子滑动的位置基于格子矩阵顶部水平线</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>tileGroup<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>reusedTile<span class="token punctuation">)</span>

        <span class="token comment">// 让格子移动到下面，并且填充到指定位置</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">moveDownTile</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="下落动画"><a href="#下落动画" class="header-anchor">#</a> 下落动画</h3> <p>填充的过程也需要给个动画效果，咱们就让它从上往下落下吧~</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 向下移动铺满被消除的格子位置</span>
  <span class="token function">moveDownTile</span><span class="token punctuation">(</span><span class="token parameter">fromRow<span class="token punctuation">,</span> fromCol<span class="token punctuation">,</span> toRow<span class="token punctuation">,</span> justMove</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// 一个格子可以只是移动(当它是一个“新的”格子从上面落下)</span>
    <span class="token comment">// 必须移动更新游戏画布位置(当它是一个“旧”格子从之前的位置下降)，justMove标志处理此操作</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>justMove<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      <span class="token comment">// 将格子本身及其值保存在临时变量中</span>
      <span class="token keyword">const</span> tileToMove <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>fromRow<span class="token punctuation">]</span><span class="token punctuation">[</span>fromCol<span class="token punctuation">]</span><span class="token punctuation">.</span>tileSprite<span class="token punctuation">;</span>
      <span class="token keyword">const</span> tileValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>fromRow<span class="token punctuation">]</span><span class="token punctuation">[</span>fromCol<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>

      <span class="token comment">// 调整格子数组，在新的位置创建格子</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>toRow<span class="token punctuation">]</span><span class="token punctuation">[</span>fromCol<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
        tileSprite<span class="token operator">:</span> tileToMove<span class="token punctuation">,</span>
        isEmpty<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        coordinate<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Phaser<span class="token punctuation">.</span>Point</span><span class="token punctuation">(</span>fromCol<span class="token punctuation">,</span> toRow<span class="token punctuation">)</span><span class="token punctuation">,</span>
        value<span class="token operator">:</span> tileValue
      <span class="token punctuation">}</span>

      <span class="token comment">// 旧的的位置现在设置为空</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>fromRow<span class="token punctuation">]</span><span class="token punctuation">[</span>fromCol<span class="token punctuation">]</span><span class="token punctuation">.</span>isEmpty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 移动的距离，以像素为单位（以此作为动画时长的值）</span>
    <span class="token keyword">const</span> distanceToTravel <span class="token operator">=</span> <span class="token punctuation">(</span>toRow <span class="token operator">*</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">+</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>toRow<span class="token punctuation">]</span><span class="token punctuation">[</span>fromCol<span class="token punctuation">]</span><span class="token punctuation">.</span>tileSprite<span class="token punctuation">.</span>y

    <span class="token comment">// 每个格子都有独立的补间动画效果</span>
    <span class="token keyword">const</span> tween <span class="token operator">=</span> game<span class="token punctuation">.</span>add<span class="token punctuation">.</span><span class="token function">tween</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tilesArray<span class="token punctuation">[</span>toRow<span class="token punctuation">]</span><span class="token punctuation">[</span>fromCol<span class="token punctuation">]</span><span class="token punctuation">.</span>tileSprite<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      y<span class="token operator">:</span> toRow <span class="token operator">*</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">+</span> gameOptions<span class="token punctuation">.</span>tileSize <span class="token operator">/</span> <span class="token number">2</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> distanceToTravel <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> Phaser<span class="token punctuation">.</span>Easing<span class="token punctuation">.</span>Linear<span class="token punctuation">.</span>None<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 看看有多少补间动画还在执行者，如果这是最后一个活动补间，格子的移动流程就完成了</span>
    tween<span class="token punctuation">.</span>onComplete<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>tween<span class="token punctuation">.</span>manager<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 分数累加，一次加 10</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">+=</span> <span class="token number">10</span>
        <span class="token comment">// 改变画布视图的文案</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>scoreText<span class="token punctuation">.</span>text <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>score<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">分</span><span class="token template-punctuation string">`</span></span>
        <span class="token comment">// 处理善后</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">endMove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 设置完成动画</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>finishAnimation <span class="token operator">=</span> <span class="token boolean">true</span>
          <span class="token comment">// 计时器提前结束，进入关卡界面</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gameTime <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replayGame</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>游戏格子矩阵使用双循环构建，组成8*8的矩阵网格</li> <li>格子元素使用<code>sprite</code>生成</li> <li>每个格子分配一个随机值，值由Phaser引擎<code>Phaser.rnd.integerInRange</code>提供</li> <li>游戏障碍物是通过在格子矩阵中随机抽取其中一个，将其的value值设置成10~13（正常能消除的value值我0~3）</li> <li>利用Phaser的<code>input</code>事件监听玩家点击操作，取其x轴和y轴的焦点去定位到具体的格子</li> <li>递归扫描点击的格子四周是否有同等值格子，有则将其加入到filled数组中，数组长度判断是否执行销毁事件</li> <li>格子销毁和格子填充均使用<code>tween</code>补间动画</li> <li>游戏设置关卡机制，总共有十个关卡，每个关卡游戏时长10秒钟（游戏时长是可以根据需求设置的），十秒钟结束后切换至关卡确认页面，十关结束后玩家可以继续游玩</li></ul> <p><a href="http://39.108.221.55:5100" target="_blank" rel="noopener noreferrer">在线玩耍地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://gitee.com/smallzip/eliminate/tree/master" target="_blank" rel="noopener noreferrer">代码仓库地址<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="https://github1s.com/jianpiao/eliminate/blob/HEAD/game.js" target="_blank" rel="noopener noreferrer">在线代码阅读<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h2> <p><a href="https://www.phaser-china.com/example.html" target="_blank" rel="noopener noreferrer">Phaser小站实例<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="http://book.phaser-china.com/SPRITE.html" target="_blank" rel="noopener noreferrer">Phaser从入门到精通<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://stonetingxin.gitbooks.io/phaser/content/fist___games/sprites.html" target="_blank" rel="noopener noreferrer">Phaser学习笔记<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://github.com/http-party/http-server" target="_blank" rel="noopener noreferrer">http-server<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/12/2022, 5:47:05 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/phaser/红包雨.html" class="prev">
        红包雨
      </a></span> <span class="next"><a href="/phaser/摘星星.html">
        Phaser游戏引擎初体验
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7d4f3de2.js" defer></script><script src="/assets/js/2.26b4ca92.js" defer></script><script src="/assets/js/43.3f9d03e3.js" defer></script>
  </body>
</html>
