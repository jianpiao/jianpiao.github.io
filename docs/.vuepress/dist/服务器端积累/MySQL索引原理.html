<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL索引原理 | smallzip‘s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="smallzip 个人博客">
    
    <link rel="preload" href="/assets/css/0.styles.ac52e467.css" as="style"><link rel="preload" href="/assets/js/app.1380078e.js" as="script"><link rel="preload" href="/assets/js/2.f1f985fe.js" as="script"><link rel="preload" href="/assets/js/51.1566902b.js" as="script"><link rel="prefetch" href="/assets/js/10.ace93e3a.js"><link rel="prefetch" href="/assets/js/11.7766a324.js"><link rel="prefetch" href="/assets/js/12.a52da1b1.js"><link rel="prefetch" href="/assets/js/13.c2b72da5.js"><link rel="prefetch" href="/assets/js/14.2d1a037d.js"><link rel="prefetch" href="/assets/js/15.93c6a531.js"><link rel="prefetch" href="/assets/js/16.ffdc05d4.js"><link rel="prefetch" href="/assets/js/17.6c550a99.js"><link rel="prefetch" href="/assets/js/18.55787257.js"><link rel="prefetch" href="/assets/js/19.2041c2db.js"><link rel="prefetch" href="/assets/js/20.7fc3a291.js"><link rel="prefetch" href="/assets/js/21.8dafd1ef.js"><link rel="prefetch" href="/assets/js/22.5a5802cd.js"><link rel="prefetch" href="/assets/js/23.2625103b.js"><link rel="prefetch" href="/assets/js/24.83c71f0e.js"><link rel="prefetch" href="/assets/js/25.adcd711b.js"><link rel="prefetch" href="/assets/js/26.b0b35c95.js"><link rel="prefetch" href="/assets/js/27.063cd3af.js"><link rel="prefetch" href="/assets/js/28.f14e33ac.js"><link rel="prefetch" href="/assets/js/29.324e2616.js"><link rel="prefetch" href="/assets/js/3.0c12ffa6.js"><link rel="prefetch" href="/assets/js/30.dac1e66c.js"><link rel="prefetch" href="/assets/js/31.b41c694c.js"><link rel="prefetch" href="/assets/js/32.e375536e.js"><link rel="prefetch" href="/assets/js/33.612be264.js"><link rel="prefetch" href="/assets/js/34.c5d5fabc.js"><link rel="prefetch" href="/assets/js/35.b1a84ab8.js"><link rel="prefetch" href="/assets/js/36.c5417075.js"><link rel="prefetch" href="/assets/js/37.94026763.js"><link rel="prefetch" href="/assets/js/38.d9884b1e.js"><link rel="prefetch" href="/assets/js/39.31984489.js"><link rel="prefetch" href="/assets/js/4.c5881052.js"><link rel="prefetch" href="/assets/js/40.f05646bc.js"><link rel="prefetch" href="/assets/js/41.0fcb7e36.js"><link rel="prefetch" href="/assets/js/42.eaf0331e.js"><link rel="prefetch" href="/assets/js/43.09818913.js"><link rel="prefetch" href="/assets/js/44.e883dc07.js"><link rel="prefetch" href="/assets/js/45.a62257dc.js"><link rel="prefetch" href="/assets/js/46.ee204913.js"><link rel="prefetch" href="/assets/js/47.2665e27c.js"><link rel="prefetch" href="/assets/js/48.e9956909.js"><link rel="prefetch" href="/assets/js/49.c7375770.js"><link rel="prefetch" href="/assets/js/5.1cc4cbbf.js"><link rel="prefetch" href="/assets/js/50.b4ae152b.js"><link rel="prefetch" href="/assets/js/52.25a1febd.js"><link rel="prefetch" href="/assets/js/53.dbc9d1d2.js"><link rel="prefetch" href="/assets/js/54.bf8ae1fd.js"><link rel="prefetch" href="/assets/js/55.9bd8c2e3.js"><link rel="prefetch" href="/assets/js/6.570ed87f.js"><link rel="prefetch" href="/assets/js/7.752b2360.js"><link rel="prefetch" href="/assets/js/8.20836500.js"><link rel="prefetch" href="/assets/js/9.5e5f312a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ac52e467.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">smallzip‘s Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/e0d0e6cb34d2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.im/user/5a68b1945188256922633d02" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/jianpiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/e0d0e6cb34d2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.im/user/5a68b1945188256922633d02" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/jianpiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/《javascript高级程序设计》笔记.html" class="sidebar-link">《javascript高级程序设计》笔记</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>javascript技术积累</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/linux笔记.html" class="sidebar-link">linux笔记</a></li><li><a href="/linux课堂代码案例.html" class="sidebar-link">linux课堂代码案例</a></li><li><a href="/算法学习笔记.html" class="sidebar-link">算法学习笔记</a></li><li><a href="/js数据结构与算法.html" class="sidebar-link">js数据结构与算法</a></li><li><a href="/javascript设计模式.html" class="sidebar-link">javascript设计模式</a></li><li><a href="/了解HTTP.html" class="sidebar-link">了解HTTP</a></li><li><a href="/Flutter学习笔记.html" class="sidebar-link">Flutter学习笔记</a></li><li><a href="/css学习笔记.html" class="sidebar-link">css学习笔记</a></li><li><a href="/Vue.html" class="sidebar-link">Vue</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React记录</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/React-Native.html" class="sidebar-link">React-Native记录</a></li><li><a href="/小程序记录.html" class="sidebar-link">小程序笔记</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/webpack.html" class="sidebar-link">Webpack</a></li><li><a href="/js正则积累.html" class="sidebar-link">js正则积累</a></li><li><a href="/前端题目练习.html" class="sidebar-link">前端题目练习</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>服务器端积累</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/服务器端积累/服务器端积累.html" class="sidebar-link">服务器端日常应用积累</a></li><li><a href="/服务器端积累/MySQL索引原理.html" class="active sidebar-link">MySQL索引原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/服务器端积累/MySQL索引原理.html#索引的本质" class="sidebar-link">索引的本质</a></li><li class="sidebar-sub-header"><a href="/服务器端积累/MySQL索引原理.html#索引底层结构" class="sidebar-link">索引底层结构</a></li><li class="sidebar-sub-header"><a href="/服务器端积累/MySQL索引原理.html#myisam索引" class="sidebar-link">MyISAM索引</a></li><li class="sidebar-sub-header"><a href="/服务器端积累/MySQL索引原理.html#innodb索引" class="sidebar-link">InnoDB索引</a></li><li class="sidebar-sub-header"><a href="/服务器端积累/MySQL索引原理.html#小结" class="sidebar-link">小结</a></li></ul></li></ul></section></li><li><a href="/计算机基础.html" class="sidebar-link">计算机基础</a></li><li><a href="/网络基础知识.html" class="sidebar-link">网络基础</a></li><li><a href="/基础面试要点知识.html" class="sidebar-link">基础面试知识积累</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql索引原理"><a href="#mysql索引原理" class="header-anchor">#</a> MySQL索引原理</h1> <p>学习MySQL数据库索引原理知识，同时了解与性能相关的优化实践。</p> <p>讲述关于索引的原理，为后面数据库优化提供合适的方案。</p> <h2 id="索引的本质"><a href="#索引的本质" class="header-anchor">#</a> 索引的本质</h2> <p>mysql的索引做了合理的数据结构转换，查询庞大数据的情况下，极大的提高了效率。</p> <h3 id="本质"><a href="#本质" class="header-anchor">#</a> 本质</h3> <p><strong>索引</strong>是能够在MySQL对数据<strong>进行排序，<strong>生成新的</strong>数据结构</strong>，最终实现高效率查询数据的一种方式。总的来说，索引就是一种数据结构。</p> <h2 id="索引底层结构"><a href="#索引底层结构" class="header-anchor">#</a> 索引底层结构</h2> <p>索引的数据结构有如下几种：</p> <ul><li>二叉树</li> <li>红黑树</li> <li>Hash表</li> <li>B-Tree</li></ul> <h3 id="数据库查询"><a href="#数据库查询" class="header-anchor">#</a> 数据库查询</h3> <p>下面是一张数据库的表，有两列数据，分别是Col1和Col2，存储的都是数字。</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/457751/1625378116855-dc9dea0a-c9c1-4984-a323-ad487231f932.png" alt="image.png"></p> <p>我们来查询一下数字为89的数据，mysql语句如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> s
<span class="token keyword">where</span> s<span class="token punctuation">.</span>Col2 <span class="token operator">=</span> <span class="token number">89</span>
</code></pre></div><p>普通模式下，查询的规则是从上往下查询：</p> <p>| 34  👇🏻</p> <p>| 77  👇🏻
| 5   👇🏻</p> <p>| 91  👇🏻</p> <p>| 22 👇🏻</p> <p>| 98 👇🏻</p> <p>终止查询</p> <p>如果数据表很大，查询的数据又是在表尾的话，那么需要花费非常多的计算时间。</p> <p><strong>优化？</strong></p> <p>那么有没有想过其他的优化方案呢，减少在有有序表中的计算？如果是单纯的数字比对，表中又有键值的话，我能想到的第一个就是算法中的二分查找。但是在这里是不适用的，因为数据是无序的。</p> <h3 id="二叉树"><a href="#二叉树" class="header-anchor">#</a> 二叉树</h3> <p>利用索引来实现优化，这里使用的<strong>二叉查找树</strong>。</p> <p>给Col2所有数据设置索引，给索引的每个节点是一个键值对（key/value），键保存的是所在行位置存储于磁盘的地址指针，value保存的是所在行位置的值。</p> <p>例如：0x07：34</p> <p>索引底层使用的数据结构是二叉树，最终存储的结构图如下：</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/457751/1625377380278-4bd5623a-ef63-4f6e-8cc5-b7bd30de0575.png" alt="image.png"></p> <p>如果我们再查询89的话，从根节点34开始查找，</p> <p>| 34  👇🏻</p> <p>| 89  👇🏻</p> <p>终止查询</p> <p>二叉树查询中，左边的子节点小于它的根节点，根节点小于右边的子节点。通过这个规律就可以很快的查找到对应的值。</p> <p>效率得到了极大的提高，相比于原始的循序查询来说，减少很多不必要计算。但是索引底层用的并不是二叉树，因为二叉树对于有序列表来说是不能胜任的，我看下面的例子：</p> <h4 id="有序查询"><a href="#有序查询" class="header-anchor">#</a> 有序查询</h4> <p>下面是是二叉树存储有序的数据，我们都知道二叉树右边的子节点是小于根节点的，所以，有序的数据最终排列的结构和链表差不多。</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/457751/1625380171702-fddc0442-eac4-424f-96ee-b22b91a5b677.png" alt="image.png"></p> <p>我们查询6的结果是怎么样的呢？</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> s
<span class="token keyword">where</span> s<span class="token punctuation">.</span>Col1 <span class="token operator">=</span> <span class="token number">6</span>
</code></pre></div><p>结果如下：</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/gif/457751/1625451148852-6f18bc14-85f5-4568-831c-cb0d47d31cff.gif" alt="12.gif"></p> <p>测试链接：https://www.cs.usfca.edu/~galles/visualization/BST.html</p> <p>插入六个数字，可以看到查询的动画效果。</p> <p>查询结果是，比对了六次才查找到最终结果，和原始查询并无差别，所以二叉树只在一定场景下有用。</p> <h3 id="avl红黑树"><a href="#avl红黑树" class="header-anchor">#</a> AVL红黑树</h3> <p>二叉查找树存在不平衡的问题，那么可以通过树的叶子节点自动旋转和调整，让二叉树始终保持基本平衡的状态，这样就能够保持二叉查找树的最佳性能。基于以上思路的自调整平衡二叉树有<strong>AVL树和红黑树。</strong></p> <p>红黑树是一颗自动调整树形态的树结构，当二叉树处于一个不平衡状态下时，红黑树会自动左右旋转叶子节点以及节点变色（红色或者黑色），调整树的形态，使其保持基本的平衡，这个时候如果是查询节点，时间复杂度为O(logn)，基本上保证了查找效率。使用二叉树插入七个节点，它的形态就如同一个链表，查询底部节点需要的时间复杂度达到了O(n)，而使用红黑树则会自动化调节树的形态，使其达到平衡状态。可见下图：</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/457751/1625381367704-d0ddb7b3-1778-4f64-96d8-b49eb8b83d41.png" alt="image.png"></p> <p>如果上面的查询换成红黑树会是什么效果呢？</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> s
<span class="token keyword">where</span> s<span class="token punctuation">.</span>Col1 <span class="token operator">=</span> <span class="token number">6</span>
</code></pre></div><p>查询过程：</p> <p>| 2  👇🏻</p> <p>| 4  👇🏻</p> <p>| 6  👇🏻</p> <p>终止查询</p> <p>动画效果：</p> <p><a href="https://www.yuque.com/attachments/yuque/0/2021/gif/457751/1625450965712-bfc5cb14-ce37-481e-9592-b71bd8c8ea85.gif" target="_blank" rel="noopener noreferrer">📎111.gif<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://cdn.nlark.com/yuque/0/2021/gif/457751/1625451037561-e726ea25-3e59-4d9b-a517-f872d2af392e.gif" alt="动画"></p> <p>通过上面的动画，可以看到，查询次数明显减少，效率上得到显著的提升。但是依旧还存在问题。</p> <ul><li>数据非常大的情况下，叶子节点太深了</li> <li>每次查找叶子节点为一层，几十几百万层的查询，完全不可控</li></ul> <p>上面7个节点的形态有一点点的规律，就是有一些向右倾斜，尽管没有二叉树倾斜的厉害，但是倾斜的幅度也是挺大的，而这个只是7个节点而已，那如果有几十万上百万个节点，倾斜的幅度是不可容忍的，倾斜幅度带来的问题的查找的深度。对于查找性能来说是巨大的消耗。</p> <p>所以应对这个问题，有人考虑到了AVL树，相对于了红黑树来说，AVL树是严格意义上的**绝对平衡二叉树，**因此在调整二叉树的形态上消耗的性能更多。</p> <p>下图为VAL树:</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/457751/1625451884714-4631d3b1-a6a0-4e72-92e7-820238b9db4b.png" alt="image.png"></p> <p>相比于红黑树来说，节点的形态更加的平衡。按照层级来对比，红黑树有4层，AVL只有三层。</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/457751/1625452010907-cf138eb5-347b-4ea6-b4e6-5609903c171e.png" alt="image.png"></p> <p>同样是查询节点6，结果会如何呢？</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> s
<span class="token keyword">where</span> s<span class="token punctuation">.</span>Col1 <span class="token operator">=</span> <span class="token number">6</span>
</code></pre></div><p>查询过程：</p> <p>| 4  👇🏻</p> <p>| 6  👇🏻</p> <p>终止查询</p> <p>查询动画：</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/gif/457751/1625452322601-30a0cb44-4858-4fd6-87a7-5059e4fd4fee.gif" alt="13.gif"></p> <p>通过对比发现</p> <ul><li>叶子节点层级减少</li> <li>解决向右倾斜的问题，形态上保持了平衡</li> <li>查询效率提升，大量顺序插入不会导致查询性能的降低，从根本上解决了红黑树遇到的问题</li></ul> <p>看起来AVL树作为数据查找的数据结构挺不错的，但是AVL树并没有被作为MySQL数据库的索引数据结构。因为数据库查找的瓶颈在于磁盘的I/O操作，如果使用AVL树，每一个树节点只存储一个数据，一次磁盘I/O只能读取一个节点的数据加载到内存中，假设依旧按照上面的查询6，则需要进行两次I/O操作，相比对内存计算来说，I/O操作是效率极低的，所以数据库索引首先考虑尽量减少频繁的I/O操作。</p> <p>操作系统从上层到底层，各个层次之间存在着很多的I/O操作，比如CPU有I/O，内存有I/O，VMM有I/O，底层磁盘也有I/O。通常来说，一个上层的I/O可能会产生对磁盘的多个I/O，也就是说上层的I/O是稀疏的，底层的I/O是密集的。</p> <p>这里我们只关注磁盘的 I/O，顾名思义就是磁盘的输入输出。输入指的是对磁盘写入数据，输出指的是从磁盘读出数据。磁盘读取10kb的数据和内存计算10kb的数据所消耗的时间的不一样的，磁盘读取所消耗的时间会比内存更长（感兴趣可以了解一下磁盘I/O性能指标，和CPU计算性能指标）。根据这个特性，可以在每一个节点中尽可能多的存储一些数据，一次磁盘I/O就多家在一些数据到内存中，这个就是B+树的设计原理。</p> <h3 id="b-树"><a href="#b-树" class="header-anchor">#</a> B+树</h3> <p>B树是一种数据结构，它有如下特征</p> <ul><li>叶节点具有相同的深度，叶节点的指针为空</li> <li>所有索引元素不重复</li> <li>节点中的数据索引从左到右递增排列</li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/457751/1625382513256-3554e803-136d-4fd2-9d8f-3361a0c1aa97.png" alt="image.png"></p> <p>B树和B+树的区别：</p> <ul><li>非叶子节点不存储data，只存储索引，可以放更多的索引</li> <li>叶子结点包含所有索引字段</li> <li>叶子节点用指针链接（链表链接），提高区间访问的性能</li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/457751/1625382492617-c781d87b-a5ee-44c4-b8c8-f7822f8bf234.png" alt="image.png"></p> <p>B+树中的根节点有15、56、77，在15和56中间的白色是下一个节点的**磁盘文件地址。**除了根节点是存储在内存中之外，其他的子节点都是存储在磁盘中。当查询的值不在15~56范围区间内，且不是15也不是56的时候，会读取磁盘地址，拉取磁盘文件到内存中（这个过程俗称I/O操作，I/O操作速度是挺慢的），在内存中进行比对查找。因为内存的计算和I/O操作完全不是一个量级的，内存使用的RAM计算。</p> <h4 id="数据存储量"><a href="#数据存储量" class="header-anchor">#</a> <strong>数据存储量</strong></h4> <p>想要计算MySQL数据存储量，首先就得知道根节点有多大，因为根节点的存储在内存中的，子节点才是存在磁盘中的，那么如何查看根节点的大小呢？</p> <p>我们可以通过在Navicat Premium中进行sql语句的查询</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">GLOBAL</span> <span class="token keyword">STATUS</span> <span class="token operator">like</span> <span class="token string">'Innodb_page_size'</span>
</code></pre></div><p>结果如下：</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/457751/1625454595666-a831e29a-222f-47a2-9e6c-b074457e81ea.png" alt="image.png"></p> <p>最终查询到的大小是16kb。所以说MySQL设置一个节点最大是16kb。</p> <p>一个节点的大小是8个字节，索引指针是6个字节（15~56中间白色的区域）</p> <p>公式：<strong>16kb / (8b+6b) = 1170</strong></p> <p>所以，设置一个节点的话，最大可以存储1170个索引。</p> <p>如果层级数为三层，即高度为3，那么可以存储多少数据呢？</p> <p>公式：<strong>1170 * 1170 * 1170  = 16亿（<strong><strong>左右</strong></strong>）</strong></p> <p>哇，高度为三层，就可以存储怎么多是数据。那么如果查询的内容是20的话，只需要经过两次I/O操作，就可以查询到对应的值。</p> <h2 id="myisam索引"><a href="#myisam索引" class="header-anchor">#</a> MyISAM索引</h2> <p>MyLSAM索引文件和数据文件是分离的，即为<strong>非聚集索引</strong>。下面讲解一下文件结构和数据结构</p> <p>MyISAM的数据库一般是存在三个文件中的，分别是后缀为frm、MYD、MYI的文件，如下图：</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/457751/1625457138699-ecc60baa-2f79-40c3-ad6b-c976c3357df7.png" alt="image.png"></p> <p>每个文件的作用分别是：</p> <ul><li>frm：存储表结构相关的信息</li> <li>MYD：表数据</li> <li>MYI：表索引，就是我们建表时候是主键</li></ul> <p>下面是索引的结构图：</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/457751/1625457014817-a99c392d-ffd9-4cdf-af61-ee43b603b081.png" alt="image.png"></p> <h3 id="索引查询流程"><a href="#索引查询流程" class="header-anchor">#</a> 索引查询流程</h3> <p>如果有一个查询：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> s
<span class="token keyword">where</span> s<span class="token punctuation">.</span>Col1 <span class="token operator">=</span> <span class="token number">30</span>
</code></pre></div><p>如果使用的是索引查询，则会读第一个根节点，查找到30，它处于在15~56中间，则会进行一次I/O操作，进入到MYI文件中进行找到对应的索引，将读取的文件交给内存执行B+树查找，为没有找到数据则会进行第二次I/O操作，最终读取到了30这个索引值，索引值存储的是一个索引所在行的磁盘文件地址，这个地址是指向的MYD后缀文件，所以会进行I/O读取MYD后缀的数据表文件读取对应行的值。</p> <p>以上就是MyISAM索引引擎底层搜索所经历的流程。</p> <h2 id="innodb索引"><a href="#innodb索引" class="header-anchor">#</a> InnoDB索引</h2> <p>InnoDB索引文件是合在一起的，即索引和数据存在一个文件，因此它属于<strong>聚集索引</strong>。</p> <p>InnoDB的数据库一般存在两个文件中，分别是后缀为frm、ibd的文件，如下图：</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/457751/1625466096900-3375d928-014d-4c8c-bf38-ab12878c3a38.png" alt="image.png"></p> <p>每个文件的作用分别是：</p> <ul><li>frm：存储表结构相关信息</li> <li>ibd：存储表的索引，和所有的数据</li></ul> <p>下面是索引的结构图：</p> <p><img src="https://cdn.nlark.com/yuque/0/2021/png/457751/1625466281210-2f972342-3c46-4ca8-94ec-23ad869d367e.png" alt="image.png"></p> <h3 id="特性"><a href="#特性" class="header-anchor">#</a> 特性</h3> <ul><li>InnoDB的叶子节点存储的是每个索引所在行的所有数据字段，即所在行完整的数据。（参见最底层叶子节点索引15，下面是所在行的数据34、Bob）</li> <li>表文件本身就是B+树组织的一个索引结构文件</li> <li>由于主键和数据都是在一个文件内的，所有InnoDB必须要有主键，并且推荐使用整型的自增主键</li> <li>非主键索引结构的叶子节点存储的是主键值，这个是为了实现一致性，节省存储的空间</li></ul> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ul><li>索引底层使用的是B+Tree结构。</li> <li>索引最底层的叶子节点是排好序的链表，可以访问左右相邻节点。</li> <li>数据库类型有很多种，比如MyISAM、InnoDB，它们区别于聚集索引和非聚集索引。</li> <li>聚集索引是索引和数据都存储在一个文件中，非聚集索引是将索引和数据分别存储在不同的文件，索引键指向的是数据文件索引所在行的数据内容。</li></ul> <p>下面来解答一下几个问题。</p> <h3 id="聚集索引和非聚集索引哪个效率更高"><a href="#聚集索引和非聚集索引哪个效率更高" class="header-anchor">#</a> 聚集索引和非聚集索引哪个效率更高</h3> <p>以MyISAM数据结构和InnoDB数据结构来说：</p> <p>非聚集索引查询到索引值之后，只是拿到了索引所在行的磁盘文件地址，需要通过这个地址再进行一次I/O操作。</p> <p>聚集索引读取到叶子节点索引值之后，即那到了索引所在行的完整的数据内容，不需要额外的I/O操作。</p> <p>因此，聚集索引效率更高！</p> <h3 id="为什么innodb必须要设置索引"><a href="#为什么innodb必须要设置索引" class="header-anchor">#</a> 为什么InnoDB必须要设置索引</h3> <p>因为InnoDB是聚集索引，索引和数据都是存到在一个文件中的，如果没有索引的话，全部数据就没办法合理的组织起来。</p> <p><strong>如果放肆，就是不加索引怎么办？</strong></p> <p>如果使用InnoDB建表的时候，没有显式的指定一个主键，则会自动帮你找到一个合适的唯一索引作为主键，若找不到符合条件唯一索引条件的字段时，会生成类似于ROW_ID的虚拟列充当该表的主键。</p> <h3 id="为什么主键建议设置为整型自增"><a href="#为什么主键建议设置为整型自增" class="header-anchor">#</a> 为什么主键建议设置为整型自增</h3> <p>在索引查找的过程中，其实做的是比对计算，通过大小比对，知道所查询的索引在什么区间范围内，从根节点进行比对，根节点没有，再到叶子节点进行比对，这个过程中，使用整型是效率比较高的一种方式。</p> <p>如果使用的是字符串对比，例如要查找一个索引是asdf20，根节点的区间范围是asdf15~asdf56，那么查询过程中需要对asdf20进行字符串拆分，逐个逐个字符串进行比对，字符串比对过程中还需要转换成ASCII码，然后再进行大小比对，这个效率是及其底下的。</p> <p><strong>为什么要自增？</strong></p> <p>在创建表之后，数据库引擎会自动将主键进行排序。我们手动的设置为自增能够，减少引擎的额外计算，要不每次添加一个数据，数据库引擎都会进行所有数据排列，当短时间内处理的数据量很大时，会损耗特别多计算量。</p> <p><strong>有序链表的好处</strong></p> <p>之所以引擎会将底层叶子节点设置为有序的，是为了很好的处理一些业务场景，比如范围查找，如下面查找语句：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> s
<span class="token keyword">where</span> s<span class="token punctuation">.</span>Col2 <span class="token operator">&gt;</span> <span class="token number">20</span>
</code></pre></div><p>查找的节点不是单一节点，而是范围节点，查找的流程就是先在根节点找到索引为20的这个节点，找到之后，向下找出其底层叶子节点，利用有序链表的特性，直接把大于20的所有数据存储到集合中，输出即可！</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/25/2021, 6:56:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/服务器端积累/服务器端积累.html" class="prev">
        服务器端日常应用积累
      </a></span> <span class="next"><a href="/计算机基础.html">
        计算机基础
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.1380078e.js" defer></script><script src="/assets/js/2.f1f985fe.js" defer></script><script src="/assets/js/51.1566902b.js" defer></script>
  </body>
</html>
