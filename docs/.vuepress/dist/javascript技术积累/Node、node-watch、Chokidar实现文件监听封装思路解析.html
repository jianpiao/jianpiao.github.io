<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Node、node-watch、Chokidar实现文件监听封装思路解析 | smallzip‘s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="smallzip 个人博客">
    
    <link rel="preload" href="/assets/css/0.styles.7cfabf05.css" as="style"><link rel="preload" href="/assets/js/app.a6ca4eb6.js" as="script"><link rel="preload" href="/assets/js/2.f1f985fe.js" as="script"><link rel="preload" href="/assets/js/18.7c360b52.js" as="script"><link rel="prefetch" href="/assets/js/10.fe2fa87a.js"><link rel="prefetch" href="/assets/js/11.7b94ab1c.js"><link rel="prefetch" href="/assets/js/12.dba90d2c.js"><link rel="prefetch" href="/assets/js/13.5a2aca03.js"><link rel="prefetch" href="/assets/js/14.212f6bd9.js"><link rel="prefetch" href="/assets/js/15.72158601.js"><link rel="prefetch" href="/assets/js/16.ffdc05d4.js"><link rel="prefetch" href="/assets/js/17.fd2e708a.js"><link rel="prefetch" href="/assets/js/19.6919d9bf.js"><link rel="prefetch" href="/assets/js/20.88130740.js"><link rel="prefetch" href="/assets/js/21.70d8ffed.js"><link rel="prefetch" href="/assets/js/22.a1cf1076.js"><link rel="prefetch" href="/assets/js/23.ea4d8259.js"><link rel="prefetch" href="/assets/js/24.80e3d415.js"><link rel="prefetch" href="/assets/js/25.7e4747ea.js"><link rel="prefetch" href="/assets/js/26.c8b3318b.js"><link rel="prefetch" href="/assets/js/27.2965bb93.js"><link rel="prefetch" href="/assets/js/28.203cc688.js"><link rel="prefetch" href="/assets/js/29.50093844.js"><link rel="prefetch" href="/assets/js/3.bcd81fba.js"><link rel="prefetch" href="/assets/js/30.bf80e9da.js"><link rel="prefetch" href="/assets/js/31.11b59fac.js"><link rel="prefetch" href="/assets/js/32.73177f93.js"><link rel="prefetch" href="/assets/js/33.32c1e8ac.js"><link rel="prefetch" href="/assets/js/34.6b2d1b43.js"><link rel="prefetch" href="/assets/js/35.179ee3e5.js"><link rel="prefetch" href="/assets/js/36.c76a682c.js"><link rel="prefetch" href="/assets/js/37.bec32f25.js"><link rel="prefetch" href="/assets/js/38.61b7d885.js"><link rel="prefetch" href="/assets/js/39.ad760fb4.js"><link rel="prefetch" href="/assets/js/4.282052c7.js"><link rel="prefetch" href="/assets/js/40.3538b296.js"><link rel="prefetch" href="/assets/js/41.a297adea.js"><link rel="prefetch" href="/assets/js/42.dc1622ca.js"><link rel="prefetch" href="/assets/js/43.945c9e09.js"><link rel="prefetch" href="/assets/js/44.12a3419e.js"><link rel="prefetch" href="/assets/js/45.e590c8e1.js"><link rel="prefetch" href="/assets/js/46.e4395f29.js"><link rel="prefetch" href="/assets/js/47.7f740788.js"><link rel="prefetch" href="/assets/js/48.64ea7ad3.js"><link rel="prefetch" href="/assets/js/49.0e87e8f8.js"><link rel="prefetch" href="/assets/js/5.ecb835e2.js"><link rel="prefetch" href="/assets/js/50.fc3661df.js"><link rel="prefetch" href="/assets/js/51.b9923d5d.js"><link rel="prefetch" href="/assets/js/52.d7331a68.js"><link rel="prefetch" href="/assets/js/53.a7f08a0a.js"><link rel="prefetch" href="/assets/js/54.f6f375e8.js"><link rel="prefetch" href="/assets/js/6.d508217f.js"><link rel="prefetch" href="/assets/js/7.752b2360.js"><link rel="prefetch" href="/assets/js/8.683b259c.js"><link rel="prefetch" href="/assets/js/9.5e5f312a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7cfabf05.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">smallzip‘s Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/e0d0e6cb34d2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.im/user/5a68b1945188256922633d02" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/jianpiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/e0d0e6cb34d2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.im/user/5a68b1945188256922633d02" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/jianpiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/《javascript高级程序设计》笔记.html" class="sidebar-link">《javascript高级程序设计》笔记</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>javascript技术积累</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/javascript技术积累/日常积累.html" class="sidebar-link">Js技术积累知识点</a></li><li><a href="/javascript技术积累/深入浅出koa-static.html" class="sidebar-link">深入浅出koa-static</a></li><li><a href="/javascript技术积累/深入事件循环和定时器.html" class="sidebar-link">浏览器的生命周期</a></li><li><a href="/javascript技术积累/Node、node-watch、Chokidar实现文件监听封装思路解析.html" class="active sidebar-link">Node、node-watch、Chokidar实现文件监听封装思路解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript技术积累/Node、node-watch、Chokidar实现文件监听封装思路解析.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/Node、node-watch、Chokidar实现文件监听封装思路解析.html#场景" class="sidebar-link">场景</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/Node、node-watch、Chokidar实现文件监听封装思路解析.html#项目结构" class="sidebar-link">项目结构</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/Node、node-watch、Chokidar实现文件监听封装思路解析.html#fs-watchfile" class="sidebar-link">fs.watchFile</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/Node、node-watch、Chokidar实现文件监听封装思路解析.html#fs-watch" class="sidebar-link">fs.watch</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/Node、node-watch、Chokidar实现文件监听封装思路解析.html#node-watch" class="sidebar-link">node-watch</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/Node、node-watch、Chokidar实现文件监听封装思路解析.html#chokidar" class="sidebar-link">Chokidar</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/Node、node-watch、Chokidar实现文件监听封装思路解析.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/Node、node-watch、Chokidar实现文件监听封装思路解析.html#参考文献" class="sidebar-link">参考文献</a></li></ul></li><li><a href="/javascript技术积累/vue手动实现一个简易版subscribeAction.html" class="sidebar-link">vue手动实现简易版subscribeAction</a></li></ul></section></li><li><a href="/linux笔记.html" class="sidebar-link">linux笔记</a></li><li><a href="/linux课堂代码案例.html" class="sidebar-link">linux课堂代码案例</a></li><li><a href="/算法学习笔记.html" class="sidebar-link">算法学习笔记</a></li><li><a href="/js数据结构与算法.html" class="sidebar-link">js数据结构与算法</a></li><li><a href="/javascript设计模式.html" class="sidebar-link">javascript设计模式</a></li><li><a href="/了解HTTP.html" class="sidebar-link">了解HTTP</a></li><li><a href="/Flutter学习笔记.html" class="sidebar-link">Flutter学习笔记</a></li><li><a href="/css学习笔记.html" class="sidebar-link">css学习笔记</a></li><li><a href="/Vue.html" class="sidebar-link">Vue</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React记录</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/React-Native.html" class="sidebar-link">React-Native记录</a></li><li><a href="/小程序记录.html" class="sidebar-link">小程序笔记</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/webpack.html" class="sidebar-link">Webpack</a></li><li><a href="/js正则积累.html" class="sidebar-link">js正则积累</a></li><li><a href="/前端题目练习.html" class="sidebar-link">前端题目练习</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务器端积累</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/计算机基础.html" class="sidebar-link">计算机基础</a></li><li><a href="/网络基础知识.html" class="sidebar-link">网络基础</a></li><li><a href="/基础面试要点知识.html" class="sidebar-link">基础面试知识积累</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="node、node-watch、chokidar实现文件监听封装思路解析"><a href="#node、node-watch、chokidar实现文件监听封装思路解析" class="header-anchor">#</a> Node、node-watch、Chokidar实现文件监听封装思路解析</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>文件监听是很多业务场景中常用的功能，简单的探索一下文件监听工具的差异。</p> <h2 id="场景"><a href="#场景" class="header-anchor">#</a> 场景</h2> <p>在学习rollup过程中初始化了一个node项目，希望做到每次文件变更的时候都能够监听得到具体是哪个文件的变更，根据这个需求，我首选了node自带的<code>watch API</code>。</p> <h2 id="项目结构"><a href="#项目结构" class="header-anchor">#</a> 项目结构</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">|</span>____bundle<span class="token punctuation">.</span>js <span class="token comment">// 构建出来的包</span>
<span class="token operator">|</span>____index<span class="token punctuation">.</span>js  <span class="token comment">// 开发文件入口</span>
<span class="token operator">|</span>____README<span class="token punctuation">.</span>md 
<span class="token operator">|</span>____main<span class="token punctuation">.</span>js <span class="token comment">// 构建入口文件</span>
<span class="token operator">|</span>____package<span class="token operator">-</span>lock<span class="token punctuation">.</span>json
<span class="token operator">|</span>____package<span class="token punctuation">.</span>json
<span class="token operator">|</span>____utils<span class="token punctuation">.</span>js  <span class="token comment">// 工具函数</span>
</code></pre></div><p>这里只用到三个文件，分别是：</p> <p><code>utiles.js</code>是几个函数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">foo</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">bar</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">&quot;光环助手&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">sayHi</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hi </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><p><code>main.js</code>是入口文件，负责收集所有执行的内容</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> foo<span class="token punctuation">,</span> bar<span class="token punctuation">,</span> sayHi <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./utils.js&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> unused <span class="token operator">=</span> <span class="token string">&quot;我用不着&quot;</span><span class="token punctuation">;</span>

<span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sayHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><code>index.js</code>是rollup构建函数中心</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> rollup <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;rollup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rollup
  <span class="token punctuation">.</span><span class="token function">rollup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token operator">:</span> <span class="token string">&quot;main.js&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bundle</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> bundle<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      file<span class="token operator">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="fs-watchfile"><a href="#fs-watchfile" class="header-anchor">#</a> <code>fs.watchFile</code></h2> <p>监听单个文件，每当访问文件时会触发回调，保存文件后有可能不会及时触发回调，因为使用的轮训机制。<a href="https://nodejs.org/docs/latest-v9.x/api/fs.html#fs_fs_watchfile_filename_options_listener" target="_blank" rel="noopener noreferrer">官网地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> rollup <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;rollup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rollup
  <span class="token punctuation">.</span><span class="token function">rollup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token operator">:</span> <span class="token string">&quot;main.js&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bundle</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> bundle<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      file<span class="token operator">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token string">&quot;./bundle.js&quot;</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始监听啦~~&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">watchFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">curr<span class="token punctuation">,</span> prev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">the current mtime is: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>curr<span class="token punctuation">.</span>mtime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">the previous mtime was: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prev<span class="token punctuation">.</span>mtime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>执行以上文件内容后会生成<code>bundle.js</code>，并且会启动文件监听，控制台打印如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>开始监听
</code></pre></div><p>现在还没有变更，所以没有变化，接下来改变点东西再次保存，打印如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>开始监听
the current mtime is<span class="token operator">:</span> Wed Aug <span class="token number">18</span> <span class="token number">2021</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">12</span> <span class="token constant">GMT</span><span class="token operator">+</span><span class="token number">0800</span> <span class="token punctuation">(</span>中国标准时间<span class="token punctuation">)</span>
the previous mtime was<span class="token operator">:</span> Wed Aug <span class="token number">18</span> <span class="token number">2021</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">22</span> <span class="token constant">GMT</span><span class="token operator">+</span><span class="token number">0800</span> <span class="token punctuation">(</span>中国标准时间<span class="token punctuation">)</span>
</code></pre></div><p>接下来，不做任何变化，直接保存文件，打印如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>开始监听
the current mtime is<span class="token operator">:</span> Wed Aug <span class="token number">18</span> <span class="token number">2021</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">12</span> <span class="token constant">GMT</span><span class="token operator">+</span><span class="token number">0800</span> <span class="token punctuation">(</span>中国标准时间<span class="token punctuation">)</span>
the previous mtime was<span class="token operator">:</span> Wed Aug <span class="token number">18</span> <span class="token number">2021</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">31</span><span class="token operator">:</span><span class="token number">22</span> <span class="token constant">GMT</span><span class="token operator">+</span><span class="token number">0800</span> <span class="token punctuation">(</span>中国标准时间<span class="token punctuation">)</span>
the current mtime is<span class="token operator">:</span> Wed Aug <span class="token number">18</span> <span class="token number">2021</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">38</span><span class="token operator">:</span><span class="token number">20</span> <span class="token constant">GMT</span><span class="token operator">+</span><span class="token number">0800</span> <span class="token punctuation">(</span>中国标准时间<span class="token punctuation">)</span>
the previous mtime was<span class="token operator">:</span> Wed Aug <span class="token number">18</span> <span class="token number">2021</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span><span class="token number">12</span> <span class="token constant">GMT</span><span class="token operator">+</span><span class="token number">0800</span> <span class="token punctuation">(</span>中国标准时间<span class="token punctuation">)</span>
</code></pre></div><p>发现不做任何变更，也会被触发。其次它只支持单个文件。官网也是说不建议使用<code>watchFile</code>,它并不高效，建议使用<code>watch</code>。</p> <h2 id="fs-watch"><a href="#fs-watch" class="header-anchor">#</a> <code>fs.watch</code></h2> <p>可以监听整个目录下的文件，<a href="http://nodejs.cn/api/fs.html#fs_fspromises_watch_filename_options" target="_blank" rel="noopener noreferrer">官网地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。回调函数有两个参数</p> <ul><li>eventType：事件类型</li> <li>filename：变更的文件名称</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> rollup <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;rollup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rollup
  <span class="token punctuation">.</span><span class="token function">rollup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token operator">:</span> <span class="token string">&quot;main.js&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bundle</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> bundle<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      file<span class="token operator">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
  	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始监听~~&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token string">&quot;./&quot;</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;更新了~~~&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>执行以上文件内容后会生成<code>bundle.js</code>，并且会启动文件监听，控制台打印如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>开始监听<span class="token operator">~</span><span class="token operator">~</span>
更新了<span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span> change bundle<span class="token punctuation">.</span>js
</code></pre></div><p>接下来改变点东西再次保存，打印如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>始监听<span class="token operator">~</span><span class="token operator">~</span>
更新了<span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span> change bundle<span class="token punctuation">.</span>js
更新了<span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span> change bundle<span class="token punctuation">.</span>js
更新了<span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span> change bundle<span class="token punctuation">.</span>js
</code></pre></div><p>文件更新了两次，接下来，不做任何变化，直接保存文件，打印如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>始监听<span class="token operator">~</span><span class="token operator">~</span>
更新了<span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span> change bundle<span class="token punctuation">.</span>js
更新了<span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span> change bundle<span class="token punctuation">.</span>js
更新了<span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span> change bundle<span class="token punctuation">.</span>js
更新了<span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span> change bundle<span class="token punctuation">.</span>js
更新了<span class="token operator">~</span><span class="token operator">~</span><span class="token operator">~</span> change bundle<span class="token punctuation">.</span>js
</code></pre></div><p>同样文件更新了两次。</p> <p>其次有个比较明显的差异是，相应比较快，相比于<code>watchFile</code>的轮训效率更高。</p> <p>这里有一个问题是每次更新都触发了两次回调，这个不符合预期，可以通过文件对比的方式进行差异化检查，这里我用到了md5插件。</p> <p>代码更新如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> rollup <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;rollup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> md5 <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;md5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> old <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

rollup
  <span class="token punctuation">.</span><span class="token function">rollup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token operator">:</span> <span class="token string">&quot;main.js&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bundle</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> bundle<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      file<span class="token operator">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> filePath <span class="token operator">=</span> <span class="token string">&quot;./&quot;</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;开始监听&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>timer<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> temp <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">==</span> old<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      old <span class="token operator">=</span> temp<span class="token punctuation">;</span>

      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;更新了&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>不改变内容的情况下保存文件，不会打印&quot;更新&quot;，改变内容的情况下保存文件，会打印&quot;更新&quot;，符合预期。</p> <h2 id="node-watch"><a href="#node-watch" class="header-anchor">#</a> <code>node-watch</code></h2> <p><a href="https://github.com/yuanchuan/node-watch" target="_blank" rel="noopener noreferrer">node-watch<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>是对上面的<code>fs.watch</code>的封装和增强。它解决了以下问题：</p> <ul><li>编辑器会生成临时的文件，导致回调函数会被触发两次</li> <li>在观察单个文件保存时，回调函数只会触发一次</li> <li>解决Linux和旧版本node不支持递归的问题</li></ul> <p>使用方法如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> rollup <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;rollup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> watch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node-watch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rollup
  <span class="token punctuation">.</span><span class="token function">rollup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token operator">:</span> <span class="token string">&quot;main.js&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bundle</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> bundle<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      file<span class="token operator">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> watcher <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">&quot;./&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> recursive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;change&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">evt<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// callback</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;更新了~~~&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>每次保存文件都会触发更新，不论文件内容是否有变更。</p> <h3 id="思路"><a href="#思路" class="header-anchor">#</a> 思路</h3> <p>执行</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> watch <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node-watch&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> watcher <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">&quot;./&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> recursive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这个监听就启动了，根据源码入口找到了<code>lib/watch.js</code>文件，从中找到<code>watch</code>函数，核心代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">fpath<span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 实例一个事件触发器</span>

	<span class="token comment">// 省略一些代码，主要是负责检查传入的fpath类型是否正确，文件是否存在</span>

  <span class="token comment">// 是数组，则递归观察文件树</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>fpath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fpath<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">watch</span><span class="token punctuation">(</span>fpath<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> filterDups <span class="token operator">=</span> <span class="token function">createDupsFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">composeWatcher</span><span class="token punctuation">(</span><span class="token function">unique</span><span class="token punctuation">(</span>fpath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// unique过滤不需要监听的文件</span>
      <span class="token keyword">var</span> w <span class="token operator">=</span> <span class="token function">watch</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 递归</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        w<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token function">filterDups</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> w<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// 监听文件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>fpath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    watcher<span class="token punctuation">.</span><span class="token function">watchFile</span><span class="token punctuation">(</span>fpath<span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">emitReady</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
	<span class="token comment">// 监听目录</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">directory</span><span class="token punctuation">(</span>fpath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token function">semaphore</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">emitReady</span><span class="token punctuation">(</span>watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    watcher<span class="token punctuation">.</span><span class="token function">watchDirectory</span><span class="token punctuation">(</span>fpath<span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn<span class="token punctuation">,</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> watcher<span class="token punctuation">.</span><span class="token function">expose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一开始实例一个<code>Watcher</code>事件触发器，后面则是根据这个实例，注册所有的事件，我们看看<code>Watcher</code>构造函数做了什么工作。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> events <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;events&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;util&quot;</span><span class="token punctuation">)</span>
<span class="token comment">// 构造函数</span>
<span class="token keyword">function</span> <span class="token function">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  events<span class="token punctuation">.</span><span class="token function">EventEmitter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>watchers <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_isReady <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_isClosed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

util<span class="token punctuation">.</span><span class="token function">inherits</span><span class="token punctuation">(</span>Watcher<span class="token punctuation">,</span> events<span class="token punctuation">.</span>EventEmitter<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">expose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/* do something */</span><span class="token punctuation">}</span>
<span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">/* do something */</span><span class="token punctuation">}</span>
<span class="token comment">// 监听文件</span>
<span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">watchFile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
 	<span class="token comment">// 核心代码</span>
  <span class="token keyword">var</span> watcher <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>watcher<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'file'</span><span class="token punctuation">,</span>
    fpath<span class="token operator">:</span> parent<span class="token punctuation">,</span>
    options<span class="token operator">:</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> opts<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      encoding<span class="token operator">:</span> options<span class="token punctuation">.</span>encoding
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">compareName</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> is<span class="token punctuation">.</span><span class="token function">samePath</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">deprecationWarning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解决回调两次的问题</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 监听文件夹</span>
<span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">watchDirectory</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> options<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 兼容linux和旧版本</span>
  <span class="token function">hasNativeRecursive</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">has</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options<span class="token punctuation">.</span>recursive <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>options<span class="token punctuation">.</span>recursive<span class="token punctuation">;</span>
   	<span class="token comment">// 核心代码</span>
    <span class="token keyword">var</span> watcher <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">;</span>

    self<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>watcher<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'dir'</span><span class="token punctuation">,</span>
      fpath<span class="token operator">:</span> dir<span class="token punctuation">,</span>
      options<span class="token operator">:</span> options
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>is<span class="token punctuation">.</span><span class="token function">func</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fn<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">deprecationWarning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解决回调两次的问题</span>
      self<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>recursive <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>has<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">getSubDirectories</span><span class="token punctuation">(</span>dir<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldNotSkip</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> options<span class="token punctuation">.</span>filter<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 过滤需要忽略的文件</span>
          self<span class="token punctuation">.</span><span class="token function">watchDirectory</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> counter<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 递归</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>简单概括就是继承了<code>EventEmitter</code>的属性，实现了文件、文件夹的监听事件。</p> <h3 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h3> <ul><li>执行<code>watch</code>会创建一个<a href="http://nodejs.cn/api/events.html" target="_blank" rel="noopener noreferrer">events<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>事件触发器，其中主要是继承了<a href="http://nodejs.cn/api/events.html#events_class_eventemitter" target="_blank" rel="noopener noreferrer"><code>EventEmitter</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>类。</li> <li>在继承的基础上重写了<code>watchFile</code>和<code>watchDirectory</code>函数，实现了文件和文件夹的监听事件。</li> <li><code>watch</code>支持数组，遇到数组使用递归进行处理。</li> <li>通过判断<code>fn</code>调用的次数来解决元素<code>fs.watch</code>回调被多次调用的问题，只有调用次数为<strong>1</strong>时才执行回调。</li> <li><a href="https://github.com/yuanchuan/node-watch/blob/c69294f010cf2531907e30a81cb06d1d5c5a0546/lib/has-native-recursive.js#L56" target="_blank" rel="noopener noreferrer"><code>hasNativeRecursive</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>函数负责解决linux和旧版本Node递归的问题，解决思路是根据不同环境动态创建临时文件或者文件夹实现当前环境所支持的监听事件。文件监听依旧使用的是<code>fs.watch</code>。当监听结束之后会自动把临时文件清除。</li></ul> <p>根据对源码的解读，能够大体了解封装的思路，以及如何解决原生遗留的问题。</p> <h2 id="chokidar"><a href="#chokidar" class="header-anchor">#</a> <a href="https://github.com/paulmillr/chokidar" target="_blank" rel="noopener noreferrer">Chokidar<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>Chokidar 是一个极简高效的跨平台文件查看器。我第一次了解到Chokidar是在看vite源码的时候，vite的文件更新监听使用的正是Chokidar。除此之外，使用到Chokidar的还有 <a href="https://github.com/microsoft/vscode" target="_blank" rel="noopener noreferrer">Microsoft's Visual Studio Code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/gulpjs/gulp/" target="_blank" rel="noopener noreferrer">gulp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>,<a href="https://karma-runner.github.io/" target="_blank" rel="noopener noreferrer">karma<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://github.com/Unitech/PM2" target="_blank" rel="noopener noreferrer">PM2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="http://browserify.org/" target="_blank" rel="noopener noreferrer">browserify<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://webpack.github.io/" target="_blank" rel="noopener noreferrer">webpack<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://www.browsersync.io/" target="_blank" rel="noopener noreferrer">BrowserSync<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, and <a href="https://www.npmjs.com/browse/depended/chokidar" target="_blank" rel="noopener noreferrer">many others<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，在开发环境下都有它的身影。</p> <p>Chokidar本质上是依赖于node的<code>fs.watch</code>和<code>fs.watchFile</code>，相比于前面的node-watch，Chokidar封装的更加强壮、稳定，性能更好，有更高的CPU使用率。</p> <h3 id="使用方法"><a href="#使用方法" class="header-anchor">#</a> 使用方法</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> rollup <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;rollup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chokidar <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;chokidar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

rollup
  <span class="token punctuation">.</span><span class="token function">rollup</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    input<span class="token operator">:</span> <span class="token string">&quot;main.js&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">bundle</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> bundle<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      file<span class="token operator">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    chokidar
      <span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        ignored<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;**/node_modules/**&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;**/.git/**&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token punctuation">,</span> path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p><code>.</code>代表的是监听当前目录下所有的问题，包括<code>node_modules</code>依赖文件，所以需要使用<code>ignored</code>对不需要监听的文件进行过滤。</p> <p>运行后，每次保存文件都会触发更新，不论文件内容是否有变更。</p> <h3 id="探索思路"><a href="#探索思路" class="header-anchor">#</a> 探索思路</h3> <p>根据chokidar项目package.json找到入口文件为<code>index.js</code>，顺着使用中首先需要实例<code>watch</code>的思路，找到如下源码：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">watch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">paths<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FSWatcher</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  watcher<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>paths<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> watcher<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>封装的<code>watch</code>函数非常简单，估计核心代码都在<code>FSWatcher</code>类下面，顺藤摸瓜找<code>FSWatcher</code>类。</p> <ol><li><p>首先会先检查是否可以使用fsevents</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> canUseFsEvents <span class="token operator">=</span> FsEventsHandler<span class="token punctuation">.</span><span class="token function">canUse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>canUseFsEvents<span class="token punctuation">)</span> opts<span class="token punctuation">.</span>useFsEvents <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>根据不同的运行环境使用不同的方案，提高性能</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Initialize with proper watcher.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>useFsEvents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_fsEventsHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FsEventsHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// MacOS环境使用fsevents</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_nodeFsHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NodeFsHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 其他环境使用fs原生的API</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>动态添加监听的文件</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">paths_<span class="token punctuation">,</span> _origAdd<span class="token punctuation">,</span> _internal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>cwd<span class="token punctuation">,</span> disableGlobbing<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">;</span>
  <span class="token keyword">let</span> paths <span class="token operator">=</span> <span class="token function">unifyPaths</span><span class="token punctuation">(</span>paths_<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 处理单文件、数组、目录，返回一个路径数组</span>
  <span class="token comment">// 根据不同环境，使用不同方法进行处理</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>useFsEvents <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_fsEventsHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// fsevents</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_readyCount<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_readyCount <span class="token operator">=</span> paths<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>persistent<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_readyCount <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历数组，给每一个文件都添加观察者模式</span>
    paths<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_fsEventsHandler<span class="token punctuation">.</span><span class="token function">_addToFsEvents</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>  <span class="token comment">// Node</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_readyCount<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_readyCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_readyCount <span class="token operator">+=</span> paths<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
      paths<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token parameter">path</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 遍历数组，给每一个文件都添加观察者模式</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_nodeFsHandler<span class="token punctuation">.</span><span class="token function">_addToNodeFs</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token operator">!</span>_internal<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> _origAdd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 文件观察模式启动</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_emitReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> res<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">results</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>closed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      results<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> item<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 递归</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sysPath<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">,</span> sysPath<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>_origAdd <span class="token operator">||</span> item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>如果是在MacOS系统中，<code>fsevents-handler.js</code>负责调用原生的<code>watch</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">createFSEventsInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stop <span class="token operator">=</span> fsevents<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>stop<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">setFSEventsListener</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> realPath<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> rawEmitter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 省略代码</span>
  cont <span class="token operator">=</span> <span class="token punctuation">{</span>
    watcher<span class="token operator">:</span> <span class="token function">createFSEventsInstance</span><span class="token punctuation">(</span>watchPath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fullPath<span class="token punctuation">,</span> flags</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cont<span class="token punctuation">.</span>listeners<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> info <span class="token operator">=</span> fsevents<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cont<span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">list</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">list</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      cont<span class="token punctuation">.</span><span class="token function">rawEmitter</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>event<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>如果在其他环境下，使用Node原生的API</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">createFsWatchInstance</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> options<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> errHandler<span class="token punctuation">,</span> emitRaw</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">handleEvent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">rawEvent<span class="token punctuation">,</span> evPath</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">listener</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">emitRaw</span><span class="token punctuation">(</span>rawEvent<span class="token punctuation">,</span> evPath<span class="token punctuation">,</span> <span class="token punctuation">{</span>watchedPath<span class="token operator">:</span> path<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 监听回调</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> options<span class="token punctuation">,</span> handleEvent<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用fs依赖下的watch</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">errHandler</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 给文件列表监听事件</span>
<span class="token keyword">const</span> <span class="token function-variable function">setFsWatchFileListener</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> options<span class="token punctuation">,</span> handlers</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  cont <span class="token operator">=</span> <span class="token punctuation">{</span>
    watcher<span class="token operator">:</span> fs<span class="token punctuation">.</span><span class="token function">watchFile</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> options<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">curr<span class="token punctuation">,</span> prev</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">foreach</span><span class="token punctuation">(</span>cont<span class="token punctuation">.</span>rawEmitters<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">rawEmitter</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">rawEmitter</span><span class="token punctuation">(</span><span class="token constant">EV_CHANGE</span><span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> <span class="token punctuation">{</span>curr<span class="token punctuation">,</span> prev<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> currmtime <span class="token operator">=</span> curr<span class="token punctuation">.</span>mtimeMs<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>curr<span class="token punctuation">.</span>size <span class="token operator">!==</span> prev<span class="token punctuation">.</span>size <span class="token operator">||</span> currmtime <span class="token operator">&gt;</span> prev<span class="token punctuation">.</span>mtimeMs <span class="token operator">||</span> currmtime <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">foreach</span><span class="token punctuation">(</span>cont<span class="token punctuation">.</span>listeners<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">listener</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> curr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  FsWatchFileInstances<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> cont<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></li></ol> <p>以上就是chokidar执行的流程了。下面详细讲解一下fsevents。</p> <h3 id="fsevents"><a href="#fsevents" class="header-anchor">#</a> <a href="https://github.com/fsevents/fsevents" target="_blank" rel="noopener noreferrer">fsevents<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <p>fsevents是Chokidar的一个依赖，用于替代Node的<code>fs</code>模块来访问MacOS系统文件，它仅仅支持MacOS。</p> <p>先来看看<code>chokidar/lib/fsevents-handler.js</code>使用的例子：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">createFSEventsInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stop <span class="token operator">=</span> fsevents<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>stop<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">setFSEventsListener</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> realPath<span class="token punctuation">,</span> listener<span class="token punctuation">,</span> rawEmitter</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 省略代码</span>
  cont <span class="token operator">=</span> <span class="token punctuation">{</span>
    watcher<span class="token operator">:</span> <span class="token function">createFSEventsInstance</span><span class="token punctuation">(</span>watchPath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">fullPath<span class="token punctuation">,</span> flags</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cont<span class="token punctuation">.</span>listeners<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 如果不是MacOS则无法执行</span>
      <span class="token keyword">const</span> info <span class="token operator">=</span> fsevents<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
      cont<span class="token punctuation">.</span>listeners<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">list</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// 遍历目录，给每一个文件添加观察者模式</span>
        <span class="token function">list</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      cont<span class="token punctuation">.</span><span class="token function">rawEmitter</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>event<span class="token punctuation">,</span> fullPath<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>fsevents<strong>最核心</strong>的是写了专门针对MacOS的二进制操作源码，是用C语言写的，在fsevents源码下的<code>fsevents.node</code>文件。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Native <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./fsevents.node&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>利用封装好的操作指令，实现了<code>watch</code>操作，代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Native <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./fsevents.node&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> events <span class="token operator">=</span> Native<span class="token punctuation">.</span>constants<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> since<span class="token punctuation">,</span> handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> instance <span class="token operator">=</span> Native<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>Native<span class="token punctuation">.</span>global<span class="token punctuation">,</span> path<span class="token punctuation">,</span> since<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>instance<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">could not watch: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> instance <span class="token operator">?</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>Native<span class="token punctuation">.</span>stop<span class="token punctuation">)</span> <span class="token operator">:</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    instance <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 输出监听信息（只针对单个文件）</span>
<span class="token keyword">function</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token punctuation">,</span> flags</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    path<span class="token punctuation">,</span>
    flags<span class="token punctuation">,</span>
    event<span class="token operator">:</span> <span class="token function">getEventType</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span>
    type<span class="token operator">:</span> <span class="token function">getFileType</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span>
    changes<span class="token operator">:</span> <span class="token function">getFileChanges</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上就是fsevents所做的主要工作了。</p> <h3 id="小结-2"><a href="#小结-2" class="header-anchor">#</a> 小结</h3> <ul><li>执行<code>watch</code>，根据封装好的<code>FSWatcher</code>类，实例一个<code>watch</code>对象。</li> <li><code>FSWatcher</code>类构造函数会初始化基本信息，其中最重要是判断当前执行的系统环境，是MacOS则使用fsevents，是其他系统则使用Node。</li> <li>确定了执行的系统环境，给用户需要监听的文件(单个文件、目录、或者globs匹配路径)添加监听事件。</li> <li>如果是MacOS系统环境，使用的是fsevents封装好的<code>fsevents.node</code>Native API，实现<code>file watch</code>,文件的监听关系是属于一对一，假如目录下有多个文件，会遍历目录，给每一个文件单独执行观察者模式。<code>fsevents.node</code>是使用C语言写的二进制系统操作指令。</li> <li>如果是Linux或者Window系统环境，使用Node下fs模块的<code>watch</code>和<code>watchFile</code>。如果是目录，会递归目录，给每个文件添加观察者模式。</li> <li>chokidar会根据不同环境使用不同文件监听方案，对症下药，相比于<code>node-watch</code>，性能会更好，主要体现在CPU上。其次不需要创建临时文件，空间复杂度更优。</li> <li>chokidar在Linux或者window系统下解决调用两次的问题，解决方案是使用<code>_throttle</code>节流方法，50毫秒内的<code>change</code>只执行一次。</li></ul> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>热更新是我们开发期间最常用的功能，能够大大提高开发的效率，只要编译器保存一下就可以更新项目。比如我们咱们公司很多前端项目都是使用webpack打包工具，其中的热更新是使用HRM插件，比如vue3推荐使用的vite，文件更新正是使用的Chokidar，<a href="https://github.com/vitejs/vite/blob/fb406ce4c0fe6da3333c9d1c00477b2880d46352/packages/vite/src/node/build.ts#L486" target="_blank" rel="noopener noreferrer">vite使用Chokidar的地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>咱们公司技术大佬<a href="https://wiki.ghzs.com/display/~moweijie" target="_blank" rel="noopener noreferrer">伟杰<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>专门写了个<a href="https://github.com/weekitmo/flutter-assets-gen" target="_blank" rel="noopener noreferrer">vscode插件<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，使用的文件更新正是Chokidar。</p> <p>通过对于源码的分析，可以更好的了解Node的<code>fs.watch</code>还存在的问题，以及如何去解决这些问题，当自己遇到了相似的问题该选择使用原生的<code>fs.watch</code>还是选择轻量化的node-watch，又或者是成熟稳定的Chokidar。</p> <h2 id="参考文献"><a href="#参考文献" class="header-anchor">#</a> 参考文献</h2> <p><a href="https://github.com/vitejs/vite/tree/main/packages/vite" target="_blank" rel="noopener noreferrer">vite源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/yuanchuan/node-watch" target="_blank" rel="noopener noreferrer">node-watch源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/fsevents/fsevents" target="_blank" rel="noopener noreferrer">fsevents源码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/weekitmo/flutter-assets-gen" target="_blank" rel="noopener noreferrer">vscode插件仓库地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/25/2021, 6:56:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/javascript技术积累/深入事件循环和定时器.html" class="prev">
        浏览器的生命周期
      </a></span> <span class="next"><a href="/javascript技术积累/vue手动实现一个简易版subscribeAction.html">
        vue手动实现简易版subscribeAction
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a6ca4eb6.js" defer></script><script src="/assets/js/2.f1f985fe.js" defer></script><script src="/assets/js/18.7c360b52.js" defer></script>
  </body>
</html>
