<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入浅出koa-static | smallzip‘s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="smallzip 个人博客">
    
    <link rel="preload" href="/assets/css/0.styles.7cfabf05.css" as="style"><link rel="preload" href="/assets/js/app.7f1578d3.js" as="script"><link rel="preload" href="/assets/js/2.f1f985fe.js" as="script"><link rel="preload" href="/assets/js/25.a0e4e72b.js" as="script"><link rel="prefetch" href="/assets/js/10.6a69938f.js"><link rel="prefetch" href="/assets/js/11.8f1aaee7.js"><link rel="prefetch" href="/assets/js/12.4e9d02e3.js"><link rel="prefetch" href="/assets/js/13.71ba12e4.js"><link rel="prefetch" href="/assets/js/14.5ae202cc.js"><link rel="prefetch" href="/assets/js/15.403ebe9f.js"><link rel="prefetch" href="/assets/js/16.e5e64d38.js"><link rel="prefetch" href="/assets/js/17.4d5737ad.js"><link rel="prefetch" href="/assets/js/18.dc1c5b7f.js"><link rel="prefetch" href="/assets/js/19.01ca7958.js"><link rel="prefetch" href="/assets/js/20.119c23c7.js"><link rel="prefetch" href="/assets/js/21.5616ebc4.js"><link rel="prefetch" href="/assets/js/22.6704e652.js"><link rel="prefetch" href="/assets/js/23.f9c7f650.js"><link rel="prefetch" href="/assets/js/24.a6b70e9a.js"><link rel="prefetch" href="/assets/js/26.28afd0e6.js"><link rel="prefetch" href="/assets/js/27.967ecc52.js"><link rel="prefetch" href="/assets/js/28.d6c78215.js"><link rel="prefetch" href="/assets/js/29.942273be.js"><link rel="prefetch" href="/assets/js/3.13a4d217.js"><link rel="prefetch" href="/assets/js/30.9b03b118.js"><link rel="prefetch" href="/assets/js/31.b4c64420.js"><link rel="prefetch" href="/assets/js/32.25edf061.js"><link rel="prefetch" href="/assets/js/33.7b3ac438.js"><link rel="prefetch" href="/assets/js/34.ec9a678c.js"><link rel="prefetch" href="/assets/js/35.2e500de6.js"><link rel="prefetch" href="/assets/js/36.569b52ce.js"><link rel="prefetch" href="/assets/js/37.60e6d083.js"><link rel="prefetch" href="/assets/js/38.27245c59.js"><link rel="prefetch" href="/assets/js/39.e6df7660.js"><link rel="prefetch" href="/assets/js/4.700078b8.js"><link rel="prefetch" href="/assets/js/40.22007601.js"><link rel="prefetch" href="/assets/js/41.c66a0cdc.js"><link rel="prefetch" href="/assets/js/42.d1ed04c5.js"><link rel="prefetch" href="/assets/js/43.e3397098.js"><link rel="prefetch" href="/assets/js/44.bb2d78cd.js"><link rel="prefetch" href="/assets/js/45.e588f1a5.js"><link rel="prefetch" href="/assets/js/46.20e720dd.js"><link rel="prefetch" href="/assets/js/47.518b323b.js"><link rel="prefetch" href="/assets/js/48.87dc7b21.js"><link rel="prefetch" href="/assets/js/49.f2fec271.js"><link rel="prefetch" href="/assets/js/5.ecb835e2.js"><link rel="prefetch" href="/assets/js/50.02614a6f.js"><link rel="prefetch" href="/assets/js/51.99e21ad4.js"><link rel="prefetch" href="/assets/js/52.bd99515e.js"><link rel="prefetch" href="/assets/js/53.1f945aa8.js"><link rel="prefetch" href="/assets/js/54.c037385e.js"><link rel="prefetch" href="/assets/js/55.db51659b.js"><link rel="prefetch" href="/assets/js/56.226ac345.js"><link rel="prefetch" href="/assets/js/57.76e972e4.js"><link rel="prefetch" href="/assets/js/58.46be6cd1.js"><link rel="prefetch" href="/assets/js/6.d508217f.js"><link rel="prefetch" href="/assets/js/7.752b2360.js"><link rel="prefetch" href="/assets/js/8.15c0f86e.js"><link rel="prefetch" href="/assets/js/9.ddae39fe.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7cfabf05.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">smallzip‘s Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/e0d0e6cb34d2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.im/user/5a68b1945188256922633d02" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/jianpiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/e0d0e6cb34d2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://juejin.im/user/5a68b1945188256922633d02" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/jianpiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/《javascript高级程序设计》笔记.html" class="sidebar-link">《javascript高级程序设计》笔记</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>javascript技术积累</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/javascript技术积累/日常积累.html" class="sidebar-link">Js技术积累知识点</a></li><li><a href="/javascript技术积累/深入浅出koa-static.html" class="active sidebar-link">深入浅出koa-static</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript技术积累/深入浅出koa-static.html#背景" class="sidebar-link">背景</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/深入浅出koa-static.html#koa-static概述" class="sidebar-link">koa-static概述</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/深入浅出koa-static.html#源码解析" class="sidebar-link">源码解析</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/深入浅出koa-static.html#自己实现" class="sidebar-link">自己实现</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/深入浅出koa-static.html#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/javascript技术积累/深入事件循环和定时器.html" class="sidebar-link">深入事件循环和定时器</a></li><li><a href="/javascript技术积累/Node、node-watch、Chokidar实现文件监听封装思路解析.html" class="sidebar-link">Node、node-watch、Chokidar实现文件监听封装思路解析</a></li><li><a href="/javascript技术积累/vue手动实现一个简易版subscribeAction.html" class="sidebar-link">vue手动实现简易版subscribeAction</a></li><li><a href="/javascript技术积累/探索nodemon的实现.html" class="sidebar-link">探索nodemon的实现</a></li></ul></section></li><li><a href="/linux笔记.html" class="sidebar-link">linux笔记</a></li><li><a href="/linux课堂代码案例.html" class="sidebar-link">linux课堂代码案例</a></li><li><a href="/算法学习笔记.html" class="sidebar-link">算法学习笔记</a></li><li><a href="/js数据结构与算法.html" class="sidebar-link">js数据结构与算法</a></li><li><a href="/javascript设计模式.html" class="sidebar-link">javascript设计模式</a></li><li><a href="/了解HTTP.html" class="sidebar-link">了解HTTP</a></li><li><a href="/Flutter学习笔记.html" class="sidebar-link">Flutter学习笔记</a></li><li><a href="/css学习笔记.html" class="sidebar-link">css学习笔记</a></li><li><a href="/Vue.html" class="sidebar-link">Vue</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React记录</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/React-Native.html" class="sidebar-link">React-Native记录</a></li><li><a href="/小程序记录.html" class="sidebar-link">小程序笔记</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/webpack.html" class="sidebar-link">Webpack</a></li><li><a href="/js正则积累.html" class="sidebar-link">js正则积累</a></li><li><a href="/前端题目练习.html" class="sidebar-link">前端题目练习</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务器端积累</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/计算机基础.html" class="sidebar-link">计算机基础</a></li><li><a href="/网络基础知识.html" class="sidebar-link">网络基础</a></li><li><a href="/基础面试要点知识.html" class="sidebar-link">基础面试知识积累</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="深入浅出koa-static"><a href="#深入浅出koa-static" class="header-anchor">#</a> 深入浅出koa-static</h1> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>为了解JS与CSS是否会阻塞DOM渲染的过程中，新建了一个node项目，通过延迟加载css操作检查是否有阻塞情况，期间需要在服务器端加载css我静态文件，express自带有<code>express.static</code>方法，而koa没有静态文件加载的api，所以网上找到了<code>koa.static</code>可以实现静态文件加载，而折腾了一早上，css文件路径解析一直报错，究其原因很久，依旧没有找到具体的原因，所以开始解析其源码，了解所以然。</p> <p>以上问题将会出另外一篇文章，在此先不做讨论。</p> <h2 id="koa-static概述"><a href="#koa-static概述" class="header-anchor">#</a> koa-static概述</h2> <p>读取静态文件</p> <h4 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h4> <div class="language-basic extra-class"><pre class="language-basic"><code>npm install koa<span class="token operator">-</span><span class="token keyword">static</span>
</code></pre></div><h3 id="使用方法"><a href="#使用方法" class="header-anchor">#</a> 使用方法</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> serve <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-static&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// 使用规则：app.use(serve(root),opts);</span>
<span class="token comment">// 第二个参数可以省略</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">serve</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>root：文件路径</li> <li>opts：选项对象</li></ul> <h4 id="opts选项"><a href="#opts选项" class="header-anchor">#</a> opts选项</h4> <ul><li><code>maxage</code>浏览器缓存最大年龄（毫秒）。默认为0</li> <li><code>hidden</code>允许传输隐藏文件。默认为false</li> <li><code>index</code>默认文件名，默认为“index.html”</li> <li><code>defer</code> 如果为true则会延迟加载，先加载next()中间件，当自身执行完毕之后才会加载自身。</li> <li><code>gzip</code>当客户端支持gzip时，如果请求的扩展名为.gz的文件存在时，尝试自动服务文件的gzip版本。默认为true。</li> <li><code>br</code>当客户端支持brotli并且请求的扩展名为.br的文件存在时，请尝试自动提供文件的brtli版本（注意，brotli仅通过https接受）。默认为true。</li> <li><a href="https://github.com/koajs/send#setheaders" target="_blank" rel="noopener noreferrer">setHeaders<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>函数在响应时设置自定义标头。</li> <li><code>extensions</code> 当URL中没有扩展名时，尝试匹配传入数组中的扩展名来搜索文件。默认为false</li></ul> <h2 id="源码解析"><a href="#源码解析" class="header-anchor">#</a> 源码解析</h2> <p>以下是koa-static核心源码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>
<span class="token string">'use strict'</span>

<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span> <span class="token comment">// 错误处理</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span> <span class="token comment">// 负责路径读取</span>
<span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span>  <span class="token comment">// 负责控制台输出颜色配置</span>
<span class="token keyword">const</span> send <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-send'</span><span class="token punctuation">)</span>  <span class="token comment">// 核心插件</span>

<span class="token comment">/**
 * 省略一些没用的东西......
 */</span>

<span class="token keyword">function</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> opts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  opts <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> opts<span class="token punctuation">)</span>

  <span class="token function">assert</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token string">'root directory is required to serve files'</span><span class="token punctuation">)</span>

  <span class="token comment">// 处理option参数内容</span>
  <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'static &quot;%s&quot; %j'</span><span class="token punctuation">,</span> root<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>
  opts<span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token function">resolve</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>opts<span class="token punctuation">.</span>index <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> opts<span class="token punctuation">.</span>index <span class="token operator">=</span> opts<span class="token punctuation">.</span>index <span class="token operator">||</span> <span class="token string">'index.html'</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>opts<span class="token punctuation">.</span>defer<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// 延迟处理，即在next执行后处理</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> done <span class="token operator">=</span> <span class="token boolean">false</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'HEAD'</span> <span class="token operator">||</span> ctx<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          done <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">send</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>  <span class="token comment">// 执行操作</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> err
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 先执行下一个中间件</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">serve</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 只对HEAD和GET类型执行操作，</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'HEAD'</span> <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>method <span class="token operator">!==</span> <span class="token string">'GET'</span><span class="token punctuation">)</span> <span class="token keyword">return</span>
    <span class="token comment">// 相应已经被处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>body <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">||</span> ctx<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token comment">// eslint-disable-line</span>
    
		<span class="token comment">/****************************** 下面这里是核心  *******************************/</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">send</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>path<span class="token punctuation">,</span> opts<span class="token punctuation">)</span>  <span class="token comment">// send方法来自于koa-send依赖，我们去看看koa-send源码如何处理的</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> err
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/***************************************************************************/</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><blockquote><p>这里额外拓展一下关于http中的HEAD和GET的知识：</p> <p>HEAD和GET方法相同，只不过服务器相应时不会返回消息实体。</p> <p>一个HEAD请求的响应中，HTTP头中包含的元信息应该和一个GET请求的响应消息相同。</p> <p>一个HEAD请求的响应可被缓存，也就是说，响应中的信息可能用来更新之前缓存的实体。</p> <p>如果当前实体跟缓存实体的阈值不同（可通过Content-Length、Content-MD5、ETag或Last-Modified的变化来表明），那么这个缓存就被视为过期了。</p></blockquote> <h3 id="koa-send源码解析"><a href="#koa-send源码解析" class="header-anchor">#</a> koa-send源码解析</h3> <p>我们来看看koa-send源码是如何处理koa-static传过去的内容。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * Module dependencies.
 */</span>

<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token string">'koa-send'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> resolvePath <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'resolve-path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> createError <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http-errors'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> stat <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>stat<span class="token punctuation">)</span>
<span class="token keyword">const</span> access <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>access<span class="token punctuation">)</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">exists</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">access</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span>
  normalize<span class="token punctuation">,</span>
  basename<span class="token punctuation">,</span>
  extname<span class="token punctuation">,</span>
  resolve<span class="token punctuation">,</span>
  parse<span class="token punctuation">,</span>
  sep
<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * 省略一些没用的......
 */</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> path<span class="token punctuation">,</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">'koa context required'</span><span class="token punctuation">)</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'pathname required'</span><span class="token punctuation">)</span>

  <span class="token comment">// 省略options配置项......</span>

  <span class="token comment">// normalize path</span>
  path <span class="token operator">=</span> <span class="token function">decode</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>

  <span class="token comment">// stat</span>
  <span class="token keyword">let</span> stats
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    stats <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">stat</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token comment">// 获取文件</span>

    <span class="token comment">// Format the path to serve static file servers</span>
    <span class="token comment">// and not require a trailing slash for directories,</span>
    <span class="token comment">// so that you can do both `/directory` and `/directory/`</span>
    <span class="token comment">// 检索目标文件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>format <span class="token operator">&amp;&amp;</span> index<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        path <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        stats <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">stat</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 忽略异常处理......</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>setHeaders<span class="token punctuation">)</span> <span class="token function">setHeaders</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>res<span class="token punctuation">,</span> path<span class="token punctuation">,</span> stats<span class="token punctuation">)</span>

  <span class="token comment">// stream，流文件，顺便检查缓存，没缓存则设置缓存，有缓存则检查更新</span>
  <span class="token comment">// 这里不细说缓存原理了，可以参见：</span>
  <span class="token comment">// 1. https://segmentfault.com/a/1190000017962411?utm_source=tag-newest</span>
  <span class="token comment">// 2. https://www.cnblogs.com/chengxs/p/10396066.html</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Length'</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Last-Modified'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Last-Modified'</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>mtime<span class="token punctuation">.</span><span class="token function">toUTCString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Cache-Control'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> directives <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">max-age=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token punctuation">(</span>maxage <span class="token operator">/</span> <span class="token number">1000</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>immutable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      directives<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'immutable'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Cache-Control'</span><span class="token punctuation">,</span> directives<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">/********************************  这里是核心  *****************************************/</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>type<span class="token punctuation">)</span> ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> encodingExt<span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
	<span class="token comment">/*************************************************************************************/</span>
  <span class="token keyword">return</span> path
<span class="token punctuation">}</span>

<span class="token comment">/**
 * File type.
 * 检查文件后缀
 * 这里用到了extname，函数出自path依赖中
 */</span>

<span class="token keyword">function</span> <span class="token function">type</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> ext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> ext <span class="token operator">!==</span> <span class="token string">''</span> <span class="token operator">?</span> <span class="token function">extname</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> ext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">extname</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre></div><p>通过以上源码大体可以总结出send做的工作。</p> <ul><li>send的核心是检查文件的拓展名（后缀），去设置文件的类型（Content-Type）。</li> <li>文件是以流（steam）的形式输出。</li> <li>Content-Type又分为&quot;text/html&quot;和&quot;text/plain&quot;两种，对应Buffer/Stream，如果不是以上任何类型，那可能就是JSON类型。</li></ul> <p>此外，源码用到了几个关键的函数，下面我一一介绍一下：</p> <ul><li>extname</li> <li>normalize</li> <li>Util.promisify</li> <li>Basename</li></ul> <h3 id="extname"><a href="#extname" class="header-anchor">#</a> extname</h3> <p>extname可以获取文件的拓展名（后缀），见如下示例：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Returns: '.html'</span>

path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">'index.coffee.md'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Returns: '.md'</span>

path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">'index.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Returns: '.'</span>

path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">'index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Returns: ''</span>

path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">'.index'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Returns: ''</span>

path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">'.index.md'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Returns: '.md'</span>
</code></pre></div><h3 id="normalize"><a href="#normalize" class="header-anchor">#</a> normalize</h3> <p>normalize方法传入文件路径，解析&quot;..&quot;或者&quot;.&quot;分割字符。</p> <p>当找到多个顺序路径段分隔符，它们会被当前执行环境所替换，保留尾部的分器。</p> <p>如果路径只有一个单纯的&quot;.&quot;号，则会指定为执行当前工作目录。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 例如在POSI上：</span>
path<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token string">'/foo/bar//baz/asdf/quux/..'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Returns: '/foo/bar/baz/asdf'</span>


<span class="token comment">// 在window上：</span>
path<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token string">'C:\\temp\\\\foo\\bar\\..\\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Returns: 'C:\\temp\\foo\\'</span>


<span class="token comment">// 由于Windows识别多个路径分隔符，这两个分隔符将被Windows首选分隔符（\）的实例替换：</span>
path<span class="token punctuation">.</span>win32<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token string">'C:////temp\\\\/\\/\\/foo/bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Returns: 'C:\\temp\\foo\\bar'</span>
</code></pre></div><h3 id="util-promisify"><a href="#util-promisify" class="header-anchor">#</a> Util.promisify</h3> <p>接收一个常见的回调函数，最终转化成为一个primise的函数。</p> <p>使用方法：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> stat <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Do something with `stats`</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Handle the error.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>或者也可以使用es7的<code>async await</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> util <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> stat <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">callStat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stats <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">This directory is owned by </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>stats<span class="token punctuation">.</span>uid<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果还想深入了解可参见官网：https://nodejs.org/dist/latest-v16.x/docs/api/util.html#util_util_promisify_original</p> <h3 id="basename"><a href="#basename" class="header-anchor">#</a> basename</h3> <p>basename方法返回路径最后的一部分。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'/foo/bar/baz/asdf/quux.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回: 'quux.html'</span>

path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'/foo/bar/baz/asdf/quux.html'</span><span class="token punctuation">,</span> <span class="token string">'.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回: 'quux'</span>


path<span class="token punctuation">.</span>win32<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'C:\\foo.html'</span><span class="token punctuation">,</span> <span class="token string">'.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回: 'foo'</span>

path<span class="token punctuation">.</span>win32<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token string">'C:\\foo.HTML'</span><span class="token punctuation">,</span> <span class="token string">'.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 返回: 'foo.HTML'</span>
</code></pre></div><h2 id="自己实现"><a href="#自己实现" class="header-anchor">#</a> 自己实现</h2> <p>知道了koa-static和koa-send的工作，能不能我自己实现一个呢？</p> <p>其实完全没有问题的，最核心的工作就是</p> <ul><li>判断类型</li> <li>创建读写流</li> <li>输出给ctx.body</li></ul> <p>基于以上，我们手动实现代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 检查访问是否是静态文件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> fileType <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fileType <span class="token operator">===</span> <span class="token string">&quot;css&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&quot;css&quot;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">&quot;./public/index.css&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fileType <span class="token operator">===</span> <span class="token string">&quot;js&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fileType <span class="token operator">===</span> <span class="token string">&quot;png&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fileType <span class="token operator">===</span> <span class="token string">&quot;jpg&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// do something</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ul><li><p>在<code>koa-static</code>接收两个参数，第一参数是文件路径，如果访问的是根目录则直接传入一个英文的点&quot;.&quot;即可，如果传入是文件名称，则会向下查找。</p></li> <li><p>静态文件输出的类型取决于读取到的文件本身是什么类型，最终我们可以在Content-Type中查看具体返回的是什么类型。</p></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/25/2021, 6:56:22 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/javascript技术积累/日常积累.html" class="prev">
        Js技术积累知识点
      </a></span> <span class="next"><a href="/javascript技术积累/深入事件循环和定时器.html">
        深入事件循环和定时器
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7f1578d3.js" defer></script><script src="/assets/js/2.f1f985fe.js" defer></script><script src="/assets/js/25.a0e4e72b.js" defer></script>
  </body>
</html>
