<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vite源码分析 | smallzip‘s Blog</title>
    <meta name="generator" content="VuePress 1.4.1">
    
    <meta name="description" content="smallzip 个人博客">
    <link rel="preload" href="/assets/css/0.styles.2fc78481.css" as="style"><link rel="preload" href="/assets/js/app.7d4f3de2.js" as="script"><link rel="preload" href="/assets/js/2.26b4ca92.js" as="script"><link rel="preload" href="/assets/js/18.a740cbf4.js" as="script"><link rel="prefetch" href="/assets/js/10.b317bce3.js"><link rel="prefetch" href="/assets/js/11.8ee6c761.js"><link rel="prefetch" href="/assets/js/12.53e9bc3d.js"><link rel="prefetch" href="/assets/js/13.d11e5bb2.js"><link rel="prefetch" href="/assets/js/14.1a7ac3aa.js"><link rel="prefetch" href="/assets/js/15.95ba698e.js"><link rel="prefetch" href="/assets/js/16.12cc2725.js"><link rel="prefetch" href="/assets/js/17.0c5dc206.js"><link rel="prefetch" href="/assets/js/19.f3a4b9e9.js"><link rel="prefetch" href="/assets/js/20.cb81e1bb.js"><link rel="prefetch" href="/assets/js/21.30ba2eb0.js"><link rel="prefetch" href="/assets/js/22.9a57d305.js"><link rel="prefetch" href="/assets/js/23.f184478a.js"><link rel="prefetch" href="/assets/js/24.1a9da5cc.js"><link rel="prefetch" href="/assets/js/25.9c5fc5df.js"><link rel="prefetch" href="/assets/js/26.a05f5cb7.js"><link rel="prefetch" href="/assets/js/27.824f59c5.js"><link rel="prefetch" href="/assets/js/28.ddbde7dc.js"><link rel="prefetch" href="/assets/js/29.d5273140.js"><link rel="prefetch" href="/assets/js/3.b4eb5e10.js"><link rel="prefetch" href="/assets/js/30.6450fecd.js"><link rel="prefetch" href="/assets/js/31.aac633e0.js"><link rel="prefetch" href="/assets/js/32.0eee40b0.js"><link rel="prefetch" href="/assets/js/33.c0127169.js"><link rel="prefetch" href="/assets/js/34.403722d8.js"><link rel="prefetch" href="/assets/js/35.aa5041e5.js"><link rel="prefetch" href="/assets/js/36.985b8158.js"><link rel="prefetch" href="/assets/js/37.08e49cde.js"><link rel="prefetch" href="/assets/js/38.21290fcb.js"><link rel="prefetch" href="/assets/js/39.69a5f5a9.js"><link rel="prefetch" href="/assets/js/4.53121559.js"><link rel="prefetch" href="/assets/js/40.d8288902.js"><link rel="prefetch" href="/assets/js/41.23fba485.js"><link rel="prefetch" href="/assets/js/42.c64155f7.js"><link rel="prefetch" href="/assets/js/43.3f9d03e3.js"><link rel="prefetch" href="/assets/js/44.d04f9b22.js"><link rel="prefetch" href="/assets/js/45.1791fee7.js"><link rel="prefetch" href="/assets/js/46.aa8ff59b.js"><link rel="prefetch" href="/assets/js/47.db1c8f44.js"><link rel="prefetch" href="/assets/js/48.c2e263aa.js"><link rel="prefetch" href="/assets/js/49.e6cb0744.js"><link rel="prefetch" href="/assets/js/5.f9da8c69.js"><link rel="prefetch" href="/assets/js/50.89c360b1.js"><link rel="prefetch" href="/assets/js/51.3aa0cc1e.js"><link rel="prefetch" href="/assets/js/52.4cb1b1f8.js"><link rel="prefetch" href="/assets/js/53.f5ce2d95.js"><link rel="prefetch" href="/assets/js/54.d31076f1.js"><link rel="prefetch" href="/assets/js/55.cdaa4e53.js"><link rel="prefetch" href="/assets/js/56.4cb18d0b.js"><link rel="prefetch" href="/assets/js/57.41f6c005.js"><link rel="prefetch" href="/assets/js/58.40a34bf6.js"><link rel="prefetch" href="/assets/js/59.58bc3b05.js"><link rel="prefetch" href="/assets/js/6.1a146ec0.js"><link rel="prefetch" href="/assets/js/60.93d31dd5.js"><link rel="prefetch" href="/assets/js/61.ddb5fc0c.js"><link rel="prefetch" href="/assets/js/62.d4f15634.js"><link rel="prefetch" href="/assets/js/63.f9284901.js"><link rel="prefetch" href="/assets/js/64.ceaab1d0.js"><link rel="prefetch" href="/assets/js/65.443d5ce9.js"><link rel="prefetch" href="/assets/js/66.11b7fa9d.js"><link rel="prefetch" href="/assets/js/67.d4b48018.js"><link rel="prefetch" href="/assets/js/7.920bce8f.js"><link rel="prefetch" href="/assets/js/8.3fcb3827.js"><link rel="prefetch" href="/assets/js/9.2da28544.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2fc78481.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">smallzip‘s Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/e0d0e6cb34d2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://juejin.im/user/5a68b1945188256922633d02" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/jianpiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/e0d0e6cb34d2" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://juejin.im/user/5a68b1945188256922633d02" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/jianpiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/《javascript高级程序设计》笔记.html" class="sidebar-link">《javascript高级程序设计》笔记</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>javascript技术积累</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/javascript技术积累/日常积累.html" class="sidebar-link">Js技术积累知识点</a></li><li><a href="/javascript技术积累/深入浅出koa-static.html" class="sidebar-link">深入浅出koa-static</a></li><li><a href="/javascript技术积累/深入事件循环和定时器.html" class="sidebar-link">深入事件循环和定时器</a></li><li><a href="/javascript技术积累/Node、node-watch、Chokidar实现文件监听封装思路解析.html" class="sidebar-link">Node、node-watch、Chokidar实现文件监听封装思路解析</a></li><li><a href="/javascript技术积累/探索nodemon的实现.html" class="sidebar-link">探索nodemon的实现</a></li><li><a href="/javascript技术积累/node源码.html" class="sidebar-link">node源码分析</a></li><li><a href="/javascript技术积累/vite源码解析.html" class="active sidebar-link">vite源码分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/javascript技术积累/vite源码解析.html#启动服务" class="sidebar-link">启动服务</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/vite源码解析.html#创建服务：createserver" class="sidebar-link">创建服务：createServer</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/vite源码解析.html#vite-config-js配置信息" class="sidebar-link">vite.config.js配置信息</a></li><li class="sidebar-sub-header"><a href="/javascript技术积累/vite源码解析.html#文件更新" class="sidebar-link">文件更新</a></li></ul></li></ul></section></li><li><a href="/linux笔记.html" class="sidebar-link">linux笔记</a></li><li><a href="/linux课堂代码案例.html" class="sidebar-link">linux课堂代码案例</a></li><li><a href="/算法学习笔记.html" class="sidebar-link">算法学习笔记</a></li><li><a href="/js数据结构与算法.html" class="sidebar-link">js数据结构与算法</a></li><li><a href="/javascript设计模式.html" class="sidebar-link">javascript设计模式</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>phaser游戏引擎</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/了解HTTP.html" class="sidebar-link">了解HTTP</a></li><li><a href="/Flutter学习笔记.html" class="sidebar-link">Flutter学习笔记</a></li><li><a href="/css学习笔记.html" class="sidebar-link">css学习笔记</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>React记录</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/React-Native.html" class="sidebar-link">React-Native记录</a></li><li><a href="/小程序记录.html" class="sidebar-link">小程序笔记</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/webpack.html" class="sidebar-link">Webpack</a></li><li><a href="/js正则积累.html" class="sidebar-link">js正则积累</a></li><li><a href="/前端题目练习.html" class="sidebar-link">前端题目练习</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>服务器端积累</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/计算机基础.html" class="sidebar-link">计算机基础</a></li><li><a href="/网络基础知识.html" class="sidebar-link">网络基础</a></li><li><a href="/基础面试要点知识.html" class="sidebar-link">基础面试知识积累</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vite源码分析"><a href="#vite源码分析" class="header-anchor">#</a> vite源码分析</h1> <p>在终端输入<code>yarn serve</code>之后，项目就被快速的启动了，vite在这个过程中作了什么，起到了什么作用，为什么比webpack要快呢</p> <h2 id="启动服务"><a href="#启动服务" class="header-anchor">#</a> 启动服务</h2> <p>输入<code>yarn dev</code>之后会执行<code>vite</code>，在node_modules中找到vite项目的package.json文件，在bin命令中会执行</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token string">&quot;vite&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;bin/vite.js&quot;</span>
</code></pre></div><p>通过这个路径找到<code>bin/vite.js</code>文件，在这个文件找到了启动的函数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../dist/node/cli'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>根据上面路径找到<code>cli/index.js</code>文件。</p> <p>脚手架启动有四种类型，分别是：</p> <ul><li>dev：默认，开发</li> <li>serve：预览</li> <li>build：打包</li> <li>optimize：优化</li></ul> <h2 id="创建服务：createserver"><a href="#创建服务：createserver" class="header-anchor">#</a> 创建服务：createServer</h2> <p>配置的信息如下：</p> <p><img src="/Users/zhoujianpiao/Downloads/%E6%89%80%E6%9C%89%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF.png" alt="所有配置信息"></p> <h2 id="vite-config-js配置信息"><a href="#vite-config-js配置信息" class="header-anchor">#</a> vite.config.js配置信息</h2> <h3 id="resolveconfig"><a href="#resolveconfig" class="header-anchor">#</a> resolveConfig</h3> <p><code>resolveConfig</code>负责整合所有的配置信息。核心代码如下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">resolveConfig</span><span class="token punctuation">(</span>inlineConfig<span class="token punctuation">,</span> command<span class="token punctuation">,</span> defaultMode <span class="token operator">=</span> <span class="token string">'development'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// 省略</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> configFile <span class="token punctuation">}</span> <span class="token operator">=</span> config<span class="token punctuation">;</span>
    <span class="token comment">// 处理配置文件 vite.config.js</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>configFile <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> loadResult <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadConfigFromFile</span><span class="token punctuation">(</span>configEnv<span class="token punctuation">,</span> configFile<span class="token punctuation">,</span> config<span class="token punctuation">.</span>root<span class="token punctuation">,</span> config<span class="token punctuation">.</span>logLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;loadResult&quot;</span><span class="token punctuation">,</span>loadResult<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loadResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 合并vite.config.js的配置项</span>
            config <span class="token operator">=</span> <span class="token function">mergeConfig</span><span class="token punctuation">(</span>loadResult<span class="token punctuation">.</span>config<span class="token punctuation">,</span> config<span class="token punctuation">)</span><span class="token punctuation">;</span>
            configFile <span class="token operator">=</span> loadResult<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
            configFileDependencies <span class="token operator">=</span> loadResult<span class="token punctuation">.</span>dependencies<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最终输入：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> resolved <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>config<span class="token punctuation">,</span>
        configFile<span class="token operator">:</span> configFile <span class="token operator">?</span> <span class="token function">normalizePath$4</span><span class="token punctuation">(</span>configFile<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
        configFileDependencies<span class="token punctuation">,</span>
        inlineConfig<span class="token punctuation">,</span>
        root<span class="token operator">:</span> resolvedRoot<span class="token punctuation">,</span>
        base<span class="token operator">:</span> <span class="token constant">BASE_URL</span><span class="token punctuation">,</span>
        resolve<span class="token operator">:</span> resolveOptions<span class="token punctuation">,</span>
        publicDir<span class="token operator">:</span> resolvedPublicDir<span class="token punctuation">,</span>
        cacheDir<span class="token punctuation">,</span>
        command<span class="token punctuation">,</span>
        mode<span class="token punctuation">,</span>
        isProduction<span class="token punctuation">,</span>
        plugins<span class="token operator">:</span> userPlugins<span class="token punctuation">,</span>
        server<span class="token operator">:</span> <span class="token function">resolveServerOptions</span><span class="token punctuation">(</span>resolvedRoot<span class="token punctuation">,</span> config<span class="token punctuation">.</span>server<span class="token punctuation">)</span><span class="token punctuation">,</span>
        build<span class="token operator">:</span> resolvedBuildOptions<span class="token punctuation">,</span>
        env<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>userEnv<span class="token punctuation">,</span>
            <span class="token constant">BASE_URL</span><span class="token punctuation">,</span>
            <span class="token constant">MODE</span><span class="token operator">:</span> mode<span class="token punctuation">,</span>
            <span class="token constant">DEV</span><span class="token operator">:</span> <span class="token operator">!</span>isProduction<span class="token punctuation">,</span>
            <span class="token constant">PROD</span><span class="token operator">:</span> isProduction
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">assetsInclude</span><span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token constant">DEFAULT_ASSETS_RE</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">assetsFilter</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        logger<span class="token punctuation">,</span>
        createResolver<span class="token punctuation">,</span>
        optimizeDeps<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token operator">...</span>config<span class="token punctuation">.</span>optimizeDeps<span class="token punctuation">,</span>
            esbuildOptions<span class="token operator">:</span> <span class="token punctuation">{</span>
                keepNames<span class="token operator">:</span> <span class="token punctuation">(</span>_b <span class="token operator">=</span> config<span class="token punctuation">.</span>optimizeDeps<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> _b <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">:</span> _b<span class="token punctuation">.</span>keepNames<span class="token punctuation">,</span>
                <span class="token operator">...</span><span class="token punctuation">(</span>_c <span class="token operator">=</span> config<span class="token punctuation">.</span>optimizeDeps<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> _c <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">:</span> _c<span class="token punctuation">.</span>esbuildOptions
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> resolved
</code></pre></div><h3 id="loadconfigfromfile"><a href="#loadconfigfromfile" class="header-anchor">#</a> loadConfigFromFile</h3> <p><code>loadConfigFromFile</code>做的事情并不复杂，就是将里面的每个配置项进行执行操作。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadConfigFromFile</span><span class="token punctuation">(</span><span class="token parameter">configEnv<span class="token punctuation">,</span> configFile<span class="token punctuation">,</span> configRoot <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> logLevel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> resolvedPath<span class="token punctuation">;</span>
    <span class="token keyword">let</span> isTS <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> isMjs <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> dependencies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// check package.json for type: &quot;module&quot; and set `isMjs` to true</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> pkg <span class="token operator">=</span> <span class="token function">lookupFile</span><span class="token punctuation">(</span>configRoot<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'package.json'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkg <span class="token operator">&amp;&amp;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>pkg<span class="token punctuation">)</span><span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'module'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isMjs <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>configFile<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// explicit config path is always resolved from cwd</span>
        resolvedPath <span class="token operator">=</span> path__default<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>configFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        isTS <span class="token operator">=</span> configFile<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.ts'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 查看根目录是否有隐藏的配置</span>
        <span class="token comment">// 省略没有用的代码</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// 没有vite.config.js则直接返回null</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resolvedPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'no config file found.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> userConfig<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isMjs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> fileUrl <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pathToFileURL</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isTS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              	<span class="token comment">// 如果是ts需要先转义成为js，写入到磁盘中，再交给原生Node ESM，最后把ts文件删除</span>
                <span class="token keyword">const</span> bundled <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">bundleConfigFile</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                dependencies <span class="token operator">=</span> bundled<span class="token punctuation">.</span>dependencies<span class="token punctuation">;</span>
                fs__default<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>resolvedPath <span class="token operator">+</span> <span class="token string">'.js'</span><span class="token punctuation">,</span> bundled<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
                userConfig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import(fileUrl + '.js?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">')</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span>default<span class="token punctuation">;</span>
                fs__default<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>resolvedPath <span class="token operator">+</span> <span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{</span>
              	<span class="token comment">// 使用eval防止直接被TS/Rollup编译</span>
                userConfig <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">import(fileUrl + '?t=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">')</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span>default<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userConfig <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isTS <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isMjs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 1. try to directly require the module (assuming commonjs)</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// clear cache in case of server restart</span>
                <span class="token keyword">delete</span> require<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                userConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 省略</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userConfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					 <span class="token comment">// 2. 文件使用的ts或者是es导入，es按照rollup语法导入</span>
            <span class="token keyword">const</span> bundled <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">bundleConfigFile</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dependencies <span class="token operator">=</span> bundled<span class="token punctuation">.</span>dependencies<span class="token punctuation">;</span>
            userConfig <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">loadConfigFromBundledFile</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">,</span> bundled<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> userConfig <span class="token operator">===</span> <span class="token string">'function'</span>
            <span class="token operator">?</span> <span class="token function">userConfig</span><span class="token punctuation">(</span>configEnv<span class="token punctuation">)</span>
            <span class="token operator">:</span> userConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            path<span class="token operator">:</span> <span class="token function">normalizePath$4</span><span class="token punctuation">(</span>resolvedPath<span class="token punctuation">)</span><span class="token punctuation">,</span>
            config<span class="token punctuation">,</span>
            dependencies
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">createLogger</span><span class="token punctuation">(</span>logLevel<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>source<span class="token punctuation">.</span><span class="token function">red</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">failed to load config from </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>resolvedPath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="bundleconfigfile"><a href="#bundleconfigfile" class="header-anchor">#</a> bundleConfigFile</h3> <p><code>bundleConfigFile</code>做的工作是使用esbuild构建依赖文件，最终输出的是一个对象</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  code<span class="token operator">:</span> text<span class="token punctuation">,</span> <span class="token comment">// 构建的包字符串</span>
  dependencies<span class="token operator">:</span> <span class="token punctuation">{</span>
    inputs<span class="token operator">:</span> <span class="token punctuation">{</span> 'vite.config.js'<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 这里就是vite.config.js配置的对象信息</span>
    outputs<span class="token operator">:</span> <span class="token punctuation">{</span> 'out.js'<span class="token operator">:</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>源码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bundleConfigFile</span><span class="token punctuation">(</span><span class="token parameter">fileName<span class="token punctuation">,</span> mjs <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> esbuild<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        absWorkingDir<span class="token operator">:</span> process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        entryPoints<span class="token operator">:</span> <span class="token punctuation">[</span>fileName<span class="token punctuation">]</span><span class="token punctuation">,</span>
        outfile<span class="token operator">:</span> <span class="token string">'out.js'</span><span class="token punctuation">,</span>
        write<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        platform<span class="token operator">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
        bundle<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        format<span class="token operator">:</span> mjs <span class="token operator">?</span> <span class="token string">'esm'</span> <span class="token operator">:</span> <span class="token string">'cjs'</span><span class="token punctuation">,</span>
        sourcemap<span class="token operator">:</span> <span class="token string">'inline'</span><span class="token punctuation">,</span>
        metafile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                name<span class="token operator">:</span> <span class="token string">'externalize-deps'</span><span class="token punctuation">,</span>
                <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    build<span class="token punctuation">.</span><span class="token function">onResolve</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token operator">:</span> <span class="token regex">/.*/</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">const</span> id <span class="token operator">=</span> args<span class="token punctuation">.</span>path<span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>id<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'.'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>path__default<span class="token punctuation">.</span><span class="token function">isAbsolute</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                                external<span class="token operator">:</span> <span class="token boolean">true</span>
                            <span class="token punctuation">}</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span>
                name<span class="token operator">:</span> <span class="token string">'replace-import-meta'</span><span class="token punctuation">,</span>
                <span class="token function">setup</span><span class="token punctuation">(</span><span class="token parameter">build</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    build<span class="token punctuation">.</span><span class="token function">onLoad</span><span class="token punctuation">(</span><span class="token punctuation">{</span> filter<span class="token operator">:</span> <span class="token regex">/\.[jt]s$/</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                        <span class="token keyword">const</span> contents <span class="token operator">=</span> <span class="token keyword">await</span> fs__default<span class="token punctuation">.</span>promises<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token punctuation">{</span>
                            loader<span class="token operator">:</span> args<span class="token punctuation">.</span>path<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.ts'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">'ts'</span> <span class="token operator">:</span> <span class="token string">'js'</span><span class="token punctuation">,</span>
                            contents<span class="token operator">:</span> contents
                                <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\bimport\.meta\.url\b/g</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">file://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>args<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\b__dirname\b/g</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>path__default<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex">/\b__filename\b/g</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> text <span class="token punctuation">}</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>outputFiles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        code<span class="token operator">:</span> text<span class="token punctuation">,</span>
        dependencies<span class="token operator">:</span> result<span class="token punctuation">.</span>metafile <span class="token operator">?</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>metafile<span class="token punctuation">.</span>inputs<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="loadconfigfrombundledfile"><a href="#loadconfigfrombundledfile" class="header-anchor">#</a> loadConfigFromBundledFile</h3> <p><code>loadConfigFromBundledFile</code>则是加载配置的插件，输出的内容如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'react-refresh'</span><span class="token punctuation">,</span>
      enforce<span class="token operator">:</span> <span class="token string">'pre'</span><span class="token punctuation">,</span>
      configResolved<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> configResolved<span class="token punctuation">]</span><span class="token punctuation">,</span>
      resolveId<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> resolveId<span class="token punctuation">]</span><span class="token punctuation">,</span>
      load<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> load<span class="token punctuation">]</span><span class="token punctuation">,</span>
      transform<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> transform<span class="token punctuation">]</span><span class="token punctuation">,</span>
      transformIndexHtml<span class="token operator">:</span> <span class="token punctuation">[</span>Function<span class="token operator">:</span> transformIndexHtml<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
loadResult <span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">'/Users/zhoujianpiao/Desktop/vue/vite-project/vite.config.js'</span><span class="token punctuation">,</span>
  config<span class="token operator">:</span> <span class="token punctuation">{</span> plugins<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">[</span>Object<span class="token punctuation">]</span> <span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  dependencies<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'vite.config.js'</span> <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>源码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">loadConfigFromBundledFile</span><span class="token punctuation">(</span><span class="token parameter">fileName<span class="token punctuation">,</span> bundledCode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> extension <span class="token operator">=</span> path__default<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> defaultLoader <span class="token operator">=</span> require<span class="token punctuation">.</span>extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span><span class="token punctuation">;</span>
    require<span class="token punctuation">.</span>extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> filename</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>filename <span class="token operator">===</span> fileName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            module<span class="token punctuation">.</span><span class="token function">_compile</span><span class="token punctuation">(</span>bundledCode<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">defaultLoader</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// clear cache in case of server restart</span>
    <span class="token keyword">delete</span> require<span class="token punctuation">.</span>cache<span class="token punctuation">[</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> raw <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> config <span class="token operator">=</span> raw<span class="token punctuation">.</span>__esModule <span class="token operator">?</span> raw<span class="token punctuation">.</span>default <span class="token operator">:</span> raw<span class="token punctuation">;</span>
    require<span class="token punctuation">.</span>extensions<span class="token punctuation">[</span>extension<span class="token punctuation">]</span> <span class="token operator">=</span> defaultLoader<span class="token punctuation">;</span>
    <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>vite.config.js配置的信息会被合并。合并的源码如下：</p> <p><img src="/Users/zhoujianpiao/Downloads/mergeConfig.png" alt="mergeConfig"></p> <h2 id="文件更新"><a href="#文件更新" class="header-anchor">#</a> 文件更新</h2> <p>当文件更新之后会触发<code>change</code>函数，调用<code>handleHMRUpdate</code>函数实现文件更新</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'change'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">file</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    file <span class="token operator">=</span> <span class="token function">normalizePath$4</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 在文件更改时使moduleGraph缓存失效</span>
    moduleGraph<span class="token punctuation">.</span><span class="token function">onFileChange</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>serverConfig<span class="token punctuation">.</span>hmr <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 防止重复刷新</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">handleHMRUpdate</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>handleHMRUpdate</code>函数负责更新开发文件以及插件工具，会逐一遍历检查是否需要更新。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">handleHMRUpdate</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> server</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 触发HMR更新</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> ws<span class="token punctuation">,</span> config<span class="token punctuation">,</span> moduleGraph <span class="token punctuation">}</span> <span class="token operator">=</span> server<span class="token punctuation">;</span>
  <span class="token keyword">const</span> shortFile <span class="token operator">=</span> <span class="token function">getShortName</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> config<span class="token punctuation">.</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取更新的文件路径名称</span>

  <span class="token comment">// 检查是否有插件需要去执行自定义HMR操作</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> plugin <span class="token keyword">of</span> config<span class="token punctuation">.</span>plugins<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>handleHotUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> filteredModules <span class="token operator">=</span> <span class="token keyword">await</span> plugin<span class="token punctuation">.</span><span class="token function">handleHotUpdate</span><span class="token punctuation">(</span>hmrContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>filteredModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        hmrContext<span class="token punctuation">.</span>modules <span class="token operator">=</span> filteredModules<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 更新模块</span>
  <span class="token function">updateModules</span><span class="token punctuation">(</span>shortFile<span class="token punctuation">,</span> hmrContext<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>updateModules</code>开始执行模块更新操作。这里会针对全量更新(fullReload)和非全量更新做区分。两种场景下做不同的工作处理。</p> <p>需要更新的所有模块全部添加进<code>updates</code>数组中。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">updateModules</span><span class="token punctuation">(</span><span class="token parameter">file<span class="token punctuation">,</span> modules<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> <span class="token punctuation">{</span> config<span class="token punctuation">,</span> ws <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updates <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 存储需要更新的模块</span>
  <span class="token keyword">let</span> needFullReload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> mod <span class="token keyword">of</span> modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 检查是否需要全量更新</span>
    <span class="token keyword">const</span> hasDeadEnd <span class="token operator">=</span> <span class="token function">propagateUpdate</span><span class="token punctuation">(</span>mod<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> boundaries<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasDeadEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      needFullReload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    updates<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token comment">/*添加需要更新的模块*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>needFullReload<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 需要全量更新</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'full-reload'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 按需更新</span>
    ws<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'update'</span><span class="token punctuation">,</span>
      updates
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的更新由<code>ws.send</code>发送。</p> <p><code>ws</code>是由<code>createServer</code>函数中创建的长链接服务</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token comment">// 创建websocket长链接服务</span>
  <span class="token keyword">const</span> ws <span class="token operator">=</span> <span class="token function">createWebSocketServer</span><span class="token punctuation">(</span>httpServer<span class="token punctuation">,</span> config<span class="token punctuation">,</span> httpsOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/12/2022, 5:47:05 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/javascript技术积累/node源码.html" class="prev">
        node源码分析
      </a></span> <span class="next"><a href="/linux笔记.html">
        linux笔记
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7d4f3de2.js" defer></script><script src="/assets/js/2.26b4ca92.js" defer></script><script src="/assets/js/18.a740cbf4.js" defer></script>
  </body>
</html>
